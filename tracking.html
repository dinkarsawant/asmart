<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Order Tracking - AS Mart</title>
    
    <!-- Critical CSS (inline for immediate loading) -->
    <style>
        /* CRITICAL STYLES ONLY - Loads instantly */
        :root {
            --primary: #ff6b35;
            --secondary: #2d3436;
            --light: #f8f9fa;
            --shadow: 0 2px 20px rgba(0,0,0,0.08);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f9f9f9; 
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        /* Loading states */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Mobile-first responsive */
        @media (max-width: 768px) {
            .container { padding: 0 10px; }
            .hide-mobile { display: none !important; }
        }
        
        @media (min-width: 769px) {
            .hide-desktop { display: none !important; }
        }
    </style>
    
    <!-- Non-critical CSS (loads after page is visible) -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    </noscript>
</head>
<body>
    <!-- HEADER (Minimal for fast load) -->
    <header>
        <nav style="background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 15px 0;">
            <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
                <div onclick="window.location.href='index.html'" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <i class="fas fa-bolt" style="font-size: 28px; color: #ff6b35;"></i>
                    <h1 style="font-size: 24px; font-weight: 700;">AS <span style="color: #ff6b35;">Mart</span></h1>
                </div>
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div class="hide-mobile">
                        <a href="tracking.html" style="text-decoration: none; color: #2d3436; padding: 8px 15px; border-radius: 20px; background: #ff6b35; color: white;">
                            <i class="fas fa-map-marker-alt"></i> Track
                        </a>
                    </div>
                    <div id="userProfile" style="display: flex; align-items: center; gap: 8px; padding: 5px 15px; border-radius: 20px; background: rgba(255,107,53,0.1);">
                        <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #ff6b35, #ff8e53); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                            G
                        </div>
                        <span class="hide-mobile" style="font-weight: 500;">Guest</span>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- MAIN CONTENT (Progressive loading) -->
    <main class="container" style="padding: 2rem 0; min-height: calc(100vh - 400px);">
        <!-- TRACKING HEADER (Loads immediately) -->
        <div style="background: linear-gradient(135deg, #ff6b35, #ff8e53); color: white; padding: 2rem; border-radius: 15px; margin-bottom: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div>
                    <h1 style="margin: 0; font-size: clamp(1.5rem, 4vw, 2rem);">
                        <i class="fas fa-shipping-fast"></i> Live Order Tracking
                    </h1>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: clamp(0.9rem, 2vw, 1.1rem);">
                        Real-time tracking of your delivery in Sindhudurg
                    </p>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <span style="display: inline-flex; align-items: center; background: #d63031; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                        <i class="fas fa-circle" style="font-size: 0.5rem;"></i> LIVE
                    </span>
                    <div id="orderStatusBadge" style="background: white; color: #ff6b35; padding: 8px 16px; border-radius: 20px; font-weight: 600;">
                        <i class="fas fa-truck"></i> <span id="statusText">On the Way</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ORDER INFO (Loads immediately) -->
        <div style="background: white; border-radius: 15px; padding: 1.5rem; box-shadow: var(--shadow); margin-bottom: 2rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
            <div style="background: #f8f9fa; border-radius: 10px; padding: 1rem; border-left: 4px solid #ff6b35;">
                <div style="font-size: 0.9rem; color: #636e72; margin-bottom: 0.5rem;">
                    <i class="fas fa-receipt"></i> Order Number
                </div>
                <div id="orderNumber" style="font-size: clamp(1.1rem, 2vw, 1.3rem); font-weight: bold; color: #ff6b35;">
                    #ASM-001
                </div>
            </div>
            
            <div style="background: #f8f9fa; border-radius: 10px; padding: 1rem; border-left: 4px solid #ff6b35;">
                <div style="font-size: 0.9rem; color: #636e72; margin-bottom: 0.5rem;">
                    <i class="fas fa-clock"></i> Order Time
                </div>
                <div id="orderTime" style="font-size: clamp(1rem, 2vw, 1.1rem); font-weight: 600;">
                    Just now
                </div>
            </div>
            
            <div style="background: #f8f9fa; border-radius: 10px; padding: 1rem; border-left: 4px solid #ff6b35;">
                <div style="font-size: 0.9rem; color: #636e72; margin-bottom: 0.5rem;">
                    <i class="fas fa-map-marker-alt"></i> Delivery Location
                </div>
                <div id="deliveryAddress" style="font-size: clamp(1rem, 2vw, 1.1rem); font-weight: 600;">
                    Sindhudurg, Maharashtra
                </div>
            </div>
            
            <div style="background: #f8f9fa; border-radius: 10px; padding: 1rem; border-left: 4px solid #ff6b35;">
                <div style="font-size: 0.9rem; color: #636e72; margin-bottom: 0.5rem;">
                    <i class="fas fa-credit-card"></i> Payment
                </div>
                <div id="paymentMethod" style="font-size: clamp(1rem, 2vw, 1.1rem); font-weight: 600;">
                    Cash on Delivery
                </div>
            </div>
        </div>

        <!-- MAIN TRACKING GRID (Responsive layout) -->
        <div id="trackingMain" style="display: grid; grid-template-columns: 1fr; gap: 2rem; margin-bottom: 2rem;">
            <!-- MAP SECTION (Lazy loaded) -->
            <div>
                <div style="background: white; border-radius: 15px; padding: 1.5rem; box-shadow: var(--shadow);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                        <h3 style="margin: 0; font-size: clamp(1.1rem, 2vw, 1.3rem);">
                            <i class="fas fa-map"></i> Sindhudurg Delivery Map
                        </h3>
                        <div id="trafficStatus" style="display: inline-flex; align-items: center; gap: 5px; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; background: #fff3cd; color: #856404;">
                            <i class="fas fa-traffic-light"></i> Moderate Traffic
                        </div>
                    </div>
                    
                    <!-- Map placeholder (replaced when loaded) -->
                    <div id="mapPlaceholder" style="height: 300px; border-radius: 10px; overflow: hidden; margin: 1rem 0; position: relative;">
                        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #f0f0f0; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #666;">
                            <i class="fas fa-map" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <div>Loading map...</div>
                        </div>
                    </div>
                    
                    <!-- ETA -->
                    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 1.5rem; border-radius: 10px; text-align: center; margin: 1rem 0;">
                        <div style="font-size: 0.9rem; opacity: 0.9;">Estimated Delivery Time</div>
                        <div id="etaTime" style="font-size: clamp(2rem, 5vw, 2.5rem); font-weight: bold; margin: 0.5rem 0;">-- min</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Based on current location and traffic</div>
                    </div>
                </div>

                <!-- CHAT SECTION (Loaded later) -->
                <div id="chatSection" style="margin-top: 2rem;">
                    <!-- Chat will be loaded here -->
                </div>
            </div>

            <!-- PROGRESS & DETAILS (Loaded immediately) -->
            <div>
                <!-- Delivery Progress -->
                <div style="background: white; border-radius: 15px; padding: 1.5rem; box-shadow: var(--shadow); margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1.5rem; font-size: clamp(1.1rem, 2vw, 1.3rem);">
                        <i class="fas fa-list-ol"></i> Delivery Status
                    </h3>
                    <div id="progressSteps">
                        <!-- Progress steps will be loaded here -->
                    </div>
                </div>

                <!-- Delivery Partner -->
                <div style="background: white; border-radius: 15px; padding: 1.5rem; box-shadow: var(--shadow); margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem; font-size: clamp(1.1rem, 2vw, 1.3rem);">
                        <i class="fas fa-user"></i> Delivery Partner
                    </h3>
                    <div style="display: flex; align-items: center; gap: 1.5rem; padding: 1.5rem; background: linear-gradient(135deg, rgba(255,107,53,0.1), rgba(255,142,83,0.1)); border-radius: 10px; margin-top: 1rem; flex-wrap: wrap;">
                        <div style="width: 80px; height: 80px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #ff6b35; font-weight: bold; border: 3px solid #ff6b35;">
                            <i class="fas fa-motorcycle"></i>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                                <div>
                                    <div id="deliveryBoyName" style="font-weight: bold; font-size: clamp(1.1rem, 2vw, 1.2rem);">Rajesh Patil</div>
                                    <div id="deliveryBoyId" style="font-size: 0.9rem; color: #636e72;">ID: DLV-SD-001</div>
                                    <div style="margin-top: 0.5rem;">
                                        <div style="font-size: 0.9rem;">
                                            <i class="fas fa-star" style="color: #fdcb6e;"></i>
                                            <span id="deliveryBoyRating">4.8</span> (128 deliveries)
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <div id="deliveryBoyPhone" style="font-weight: 600;">
                                        <i class="fas fa-phone"></i> +91 98765 43210
                                    </div>
                                    <div style="font-size: 0.9rem; color: #636e72; margin-top: 0.5rem;">
                                        <i class="fas fa-motorcycle"></i> Scooter
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                        <button onclick="callDeliveryBoy()" style="flex: 1; padding: 12px; border: none; border-radius: 8px; background: #ff6b35; color: white; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <i class="fas fa-phone"></i> Call Now
                        </button>
                        <button onclick="shareLocation()" style="flex: 1; padding: 12px; border: 2px solid #dfe6e9; border-radius: 8px; background: white; color: #2d3436; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <i class="fas fa-share-location"></i> Share Location
                        </button>
                    </div>
                </div>

                <!-- Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: var(--shadow); text-align: center;">
                        <div id="distance" style="font-size: clamp(1.5rem, 3vw, 2rem); font-weight: bold; color: #ff6b35; margin-bottom: 0.5rem;">-- km</div>
                        <div style="color: #636e72; font-size: 0.9rem;">Distance Remaining</div>
                    </div>
                    
                    <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: var(--shadow); text-align: center;">
                        <div id="currentSpeed" style="font-size: clamp(1.5rem, 3vw, 2rem); font-weight: bold; color: #ff6b35; margin-bottom: 0.5rem;">-- km/h</div>
                        <div style="color: #636e72; font-size: 0.9rem;">Current Speed</div>
                    </div>
                    
                    <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: var(--shadow); text-align: center;">
                        <div id="itemsCount" style="font-size: clamp(1.5rem, 3vw, 2rem); font-weight: bold; color: #ff6b35; margin-bottom: 0.5rem;">--</div>
                        <div style="color: #636e72; font-size: 0.9rem;">Items in Order</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ORDER ITEMS & UPDATES (Loaded after) -->
        <div id="orderDetails" style="display: none;">
            <!-- Content will be loaded here -->
        </div>

        <!-- CONTROL BUTTONS -->
        <div style="display: flex; gap: 1rem; margin-top: 2rem; flex-wrap: wrap; justify-content: center;">
            <button onclick="shareTracking()" style="padding: 12px 24px; border: none; border-radius: 8px; background: #ff6b35; color: white; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;">
                <i class="fas fa-share-alt"></i> Share Tracking
            </button>
            <button onclick="markAsDelivered()" style="padding: 12px 24px; border: none; border-radius: 8px; background: #00b894; color: white; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;">
                <i class="fas fa-check-circle"></i> Mark as Delivered
            </button>
            <button onclick="reportIssue()" style="padding: 12px 24px; border: none; border-radius: 8px; background: #d63031; color: white; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;">
                <i class="fas fa-exclamation-triangle"></i> Report Issue
            </button>
        </div>
    </main>

    <!-- FOOTER (Simple) -->
    <footer style="background: #2d3436; color: white; padding: 4rem 0 2rem; margin-top: 4rem;">
        <div class="container">
            <div style="text-align: center; color: #aaa; font-size: 0.9rem;">
                <p>&copy; 2024 AS Mart. All rights reserved.</p>
                <p style="margin-top: 0.5rem;"><i class="fas fa-phone"></i> +91 96998 93401 | <i class="fas fa-envelope"></i> support@asmart.com</p>
            </div>
        </div>
    </footer>

    <!-- DEFERRED JAVASCRIPT (Loads after everything else) -->
    <script>
        // ====== FAST INITIALIZATION ======
        document.addEventListener('DOMContentLoaded', function() {
            // Load basic user info immediately
            loadUserInfo();
            
            // Load initial order data
            loadInitialOrderData();
            
            // Start progressive loading
            setTimeout(loadSecondaryContent, 100);
            
            // Load heavy resources when idle
            if ('requestIdleCallback' in window) {
                requestIdleCallback(() => {
                    loadHeavyResources();
                });
            } else {
                setTimeout(loadHeavyResources, 500);
            }
            
            // Setup basic interactions
            setupBasicInteractions();
        });

        // ====== PROGRESSIVE LOADING FUNCTIONS ======
        function loadUserInfo() {
            try {
                const userData = JSON.parse(localStorage.getItem('asmart_user') || '{}');
                const userProfile = document.getElementById('userProfile');
                if (userData.name && userProfile) {
                    userProfile.innerHTML = `
                        <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #ff6b35, #ff8e53); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                            ${userData.avatar || userData.name.charAt(0)}
                        </div>
                        <span class="hide-mobile" style="font-weight: 500;">${userData.name}</span>
                    `;
                }
            } catch (e) {
                console.log('User info load error:', e);
            }
        }

        function loadInitialOrderData() {
            try {
                // Get order from URL or use demo
                const urlParams = new URLSearchParams(window.location.search);
                const orderId = urlParams.get('order');
                
                let order = null;
                if (orderId) {
                    const orders = JSON.parse(localStorage.getItem('asmart_orders') || '[]');
                    order = orders.find(o => o.id === orderId || o.orderNumber === orderId);
                }
                
                if (!order) {
                    order = {
                        id: 'ord_' + Date.now(),
                        orderNumber: 'ASM-SD-' + Math.floor(Math.random() * 1000),
                        status: 'on_the_way',
                        orderDate: new Date().toISOString(),
                        deliveryAddress: 'Near Malvan Beach, Sindhudurg, Maharashtra 416606',
                        paymentMethod: 'Cash on Delivery'
                    };
                }
                
                // Update UI
                document.getElementById('orderNumber').textContent = '#' + order.orderNumber;
                document.getElementById('orderTime').textContent = formatTimeAgo(order.orderDate);
                document.getElementById('deliveryAddress').textContent = order.deliveryAddress;
                document.getElementById('paymentMethod').textContent = order.paymentMethod;
                
                // Load progress steps
                updateProgressSteps(order.status);
                
            } catch (e) {
                console.log('Order data load error:', e);
            }
        }

        function loadSecondaryContent() {
            // Load chat section
            loadChatSection();
            
            // Load order items and updates
            loadOrderDetails();
            
            // Initialize tracking
            startTrackingSimulation();
        }

        function loadHeavyResources() {
            // Load Leaflet map only when needed
            if (isElementInViewport(document.getElementById('mapPlaceholder'))) {
                loadMap();
            }
            
            // Add scroll listener for lazy loading
            window.addEventListener('scroll', lazyLoadContent, { passive: true });
        }

        // ====== LAZY LOADING ======
        function lazyLoadContent() {
            if (isElementInViewport(document.getElementById('mapPlaceholder'))) {
                loadMap();
                window.removeEventListener('scroll', lazyLoadContent);
            }
        }

        function loadMap() {
            // Load Leaflet dynamically
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
            script.onload = initializeMap;
            document.head.appendChild(script);
        }

        // ====== MAP FUNCTIONS (Lightweight) ======
        function initializeMap() {
            try {
                const placeholder = document.getElementById('mapPlaceholder');
                if (!placeholder) return;
                
                // Replace placeholder with actual map
                placeholder.outerHTML = '<div id="trackingMap" style="height: 300px; border-radius: 10px; overflow: hidden; margin: 1rem 0;"></div>';
                
                // Initialize simple map
                const map = L.map('trackingMap').setView([16.1201, 73.4700], 12);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap'
                }).addTo(map);
                
                // Add markers
                L.marker([16.1201, 73.4700])
                    .addTo(map)
                    .bindPopup('Your Location<br>Sindhudurg, Maharashtra');
                
                L.marker([16.1100, 73.4800])
                    .addTo(map)
                    .bindPopup('Delivery Partner<br>Rajesh Patil');
                    
            } catch (e) {
                console.log('Map init error:', e);
            }
        }

        // ====== CHAT FUNCTIONS ======
        function loadChatSection() {
            const chatSection = document.getElementById('chatSection');
            if (!chatSection) return;
            
            chatSection.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 1.5rem; box-shadow: var(--shadow);">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; border-bottom: 2px solid #dfe6e9; margin-bottom: 1rem;">
                        <h3 style="margin: 0; font-size: clamp(1.1rem, 2vw, 1.3rem);">
                            <i class="fas fa-comments"></i> Chat with Delivery Partner
                        </h3>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 8px; height: 8px; background: #00b894; border-radius: 50%;"></div>
                            <span style="font-size: 0.9rem; color: #636e72;">Online</span>
                        </div>
                    </div>
                    
                    <div id="chatMessages" style="height: 200px; overflow-y: auto; padding: 1rem; background: #f0f2f5; border-radius: 10px; margin-bottom: 1rem;">
                        <div style="text-align: center; color: #666; padding: 2rem;">
                            Chat will load shortly...
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="chatInput" style="flex: 1; padding: 12px 15px; border: 2px solid #dfe6e9; border-radius: 25px; outline: none;" 
                               placeholder="Type your message here..." onkeypress="if(event.key==='Enter') sendMessage()">
                        <button onclick="sendMessage()" style="background: #ff6b35; color: white; border: none; border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            `;
            
            // Load chat messages
            setTimeout(loadChatMessages, 500);
        }

        function loadChatMessages() {
            const container = document.getElementById('chatMessages');
            if (!container) return;
            
            const messages = [
                { sender: 'delivery', message: 'Hello! I\'m Rajesh, your delivery partner.', time: new Date(Date.now() - 15 * 60000) },
                { sender: 'delivery', message: 'On my way to your location in Sindhudurg.', time: new Date(Date.now() - 10 * 60000) },
                { sender: 'user', message: 'Thanks! Please deliver to main gate.', time: new Date(Date.now() - 5 * 60000) }
            ];
            
            container.innerHTML = messages.map(msg => `
                <div style="max-width: 70%; padding: 10px 15px; border-radius: 18px; margin-bottom: 0.5rem; ${msg.sender === 'user' ? 'background: #0084ff; color: white; margin-left: auto; border-bottom-right-radius: 4px;' : 'background: #e4e6eb; color: #2d3436; border-bottom-left-radius: 4px;'}">
                    <div>${msg.message}</div>
                    <div style="font-size: 0.7rem; margin-top: 5px; opacity: 0.7; text-align: right;">${formatTimeAgo(msg.time)}</div>
                </div>
            `).join('');
            
            container.scrollTop = container.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input?.value.trim();
            
            if (message && message.length > 0) {
                const container = document.getElementById('chatMessages');
                if (container) {
                    const newMsg = `
                        <div style="max-width: 70%; padding: 10px 15px; border-radius: 18px; margin-bottom: 0.5rem; background: #0084ff; color: white; margin-left: auto; border-bottom-right-radius: 4px;">
                            <div>${message}</div>
                            <div style="font-size: 0.7rem; margin-top: 5px; opacity: 0.7; text-align: right;">Just now</div>
                        </div>
                    `;
                    container.innerHTML += newMsg;
                    input.value = '';
                    container.scrollTop = container.scrollHeight;
                    
                    // Simulate reply
                    setTimeout(() => {
                        const replies = ['Got it!', 'On my way!', 'Almost there!'];
                        const reply = replies[Math.floor(Math.random() * replies.length)];
                        container.innerHTML += `
                            <div style="max-width: 70%; padding: 10px 15px; border-radius: 18px; margin-bottom: 0.5rem; background: #e4e6eb; color: #2d3436; border-bottom-left-radius: 4px;">
                                <div>${reply}</div>
                                <div style="font-size: 0.7rem; margin-top: 5px; opacity: 0.7; text-align: right;">Just now</div>
                            </div>
                        `;
                        container.scrollTop = container.scrollHeight;
                    }, 1000);
                }
            }
        }

        // ====== ORDER DETAILS ======
        function loadOrderDetails() {
            const container = document.getElementById('orderDetails');
            if (!container) return;
            
            const items = [
                { name: 'Fresh Fish (Pomfret)', price: 350, quantity: 1 },
                { name: 'Coconut', price: 25, quantity: 3 },
                { name: 'Kokum Syrup', price: 180, quantity: 1 }
            ];
            
            container.style.display = 'grid';
            container.style.gridTemplateColumns = '1fr 1fr';
            container.style.gap = '2rem';
            container.style.marginTop = '2rem';
            
            container.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 1.5rem; box-shadow: var(--shadow);">
                    <h3 style="margin-bottom: 1rem; font-size: clamp(1.1rem, 2vw, 1.3rem);">
                        <i class="fas fa-shopping-bag"></i> Order Items
                    </h3>
                    ${items.map(item => `
                        <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 10px; margin-bottom: 1rem;">
                            <div style="width: 60px; height: 60px; border-radius: 8px; background: linear-gradient(135deg, #ff6b35, #ff8e53); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                                <i class="fas fa-shopping-bag"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">${item.name}</div>
                                <div style="font-size: 0.9rem; color: #636e72;">
                                    Quantity: ${item.quantity} × ₹${item.price}
                                </div>
                            </div>
                            <div style="font-weight: bold; color: #ff6b35;">
                                ₹${item.price * item.quantity}
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div style="background: white; border-radius: 15px; padding: 1.5rem; box-shadow: var(--shadow); max-height: 400px; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0; font-size: clamp(1.1rem, 2vw, 1.3rem);">
                            <i class="fas fa-broadcast-tower"></i> Live Updates
                        </h3>
                        <button onclick="refreshUpdates()" style="padding: 8px 16px; background: white; color: #2d3436; border: 2px solid #dfe6e9; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div id="updatesList">
                        ${generateUpdates().map(update => `
                            <div style="padding: 1rem; border-left: 3px solid #ff6b35; background: #f8f9fa; margin-bottom: 0.75rem; border-radius: 0 8px 8px 0;">
                                <div>${update.message}</div>
                                <span style="font-size: 0.8rem; color: #636e72; display: block; margin-top: 0.25rem;">
                                    <i class="far fa-clock"></i> ${formatTimeAgo(update.time)}
                                </span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            // Update items count
            document.getElementById('itemsCount').textContent = items.length;
        }

        // ====== TRACKING SIMULATION ======
        function startTrackingSimulation() {
            let distance = 5.2; // Starting distance in km
            let speed = 25; // Starting speed in km/h
            
            function update() {
                // Simulate movement
                distance = Math.max(0.1, distance - (speed / 3600) * 10); // 10 seconds of movement
                speed = 20 + Math.random() * 15; // Random speed between 20-35 km/h
                
                // Update UI
                document.getElementById('distance').textContent = distance.toFixed(1) + ' km';
                document.getElementById('currentSpeed').textContent = Math.round(speed) + ' km/h';
                
                // Update ETA
                const etaMinutes = Math.round((distance / speed) * 60);
                document.getElementById('etaTime').textContent = etaMinutes + ' min';
                
                // Update status based on distance
                if (distance < 0.5) {
                    updateStatus('arrived');
                } else if (distance < 2) {
                    updateStatus('nearby');
                }
                
                // Update traffic status based on time
                updateTrafficStatus();
            }
            
            // Start updates every 10 seconds
            setInterval(update, 10000);
            update(); // Initial update
        }

        // ====== UTILITY FUNCTIONS ======
        function updateProgressSteps(status) {
            const steps = [
                { id: 'confirmed', icon: 'fa-check-circle', label: 'Order Confirmed', completed: true },
                { id: 'preparing', icon: 'fa-utensils', label: 'Preparing Order', completed: true },
                { id: 'on_the_way', icon: 'fa-truck', label: 'On the Way', active: status === 'on_the_way' },
                { id: 'nearby', icon: 'fa-map-marker-alt', label: 'Nearby', active: status === 'nearby' },
                { id: 'delivered', icon: 'fa-check-circle', label: 'Delivered', active: status === 'delivered' }
            ];
            
            const container = document.getElementById('progressSteps');
            if (!container) return;
            
            container.innerHTML = steps.map(step => `
                <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: ${step.active ? 'rgba(255,107,53,0.1)' : step.completed ? 'rgba(0,184,148,0.1)' : '#f8f9fa'}; border-radius: 10px; margin-bottom: 1rem; border-left: 4px solid ${step.active ? '#ff6b35' : step.completed ? '#00b894' : '#ff6b35'};">
                    <div style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; background: ${step.active ? '#ff6b35' : step.completed ? '#00b894' : 'white'}; color: ${step.active || step.completed ? 'white' : '#ff6b35'}; border: 2px solid ${step.active ? '#ff6b35' : step.completed ? '#00b894' : '#dfe6e9'};">
                        <i class="fas ${step.icon}"></i>
                    </div>
                    <div>
                        <div style="font-weight: 600;">${step.label}</div>
                        <div style="font-size: 0.8rem; color: #636e72;">
                            ${step.id === 'confirmed' ? 'Order received and confirmed' : 
                              step.id === 'preparing' ? 'Items are being packed' :
                              step.id === 'on_the_way' ? 'Delivery partner is on the way' :
                              step.id === 'nearby' ? 'Delivery partner is nearby' :
                              'Order delivered successfully'}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateStatus(status) {
            const statusText = document.getElementById('statusText');
            const badge = document.getElementById('orderStatusBadge');
            
            if (!statusText || !badge) return;
            
            let display = 'On the Way';
            let icon = 'fa-truck';
            let color = '#ff6b35';
            
            if (status === 'nearby') {
                display = 'Nearby';
                icon = 'fa-map-marker-alt';
                color = '#28a745';
            } else if (status === 'arrived') {
                display = 'Arrived';
                icon = 'fa-home';
                color = '#28a745';
            } else if (status === 'delivered') {
                display = 'Delivered';
                icon = 'fa-check-circle';
                color = '#28a745';
            }
            
            statusText.textContent = display;
            badge.innerHTML = `<i class="fas ${icon}"></i> ${display}`;
            badge.style.background = color;
            badge.style.color = 'white';
            
            updateProgressSteps(status);
        }

        function updateTrafficStatus() {
            const hour = new Date().getHours();
            const element = document.getElementById('trafficStatus');
            
            if (!element) return;
            
            let status, icon, className;
            
            if (hour >= 7 && hour <= 10) {
                status = 'Heavy Traffic';
                icon = 'fa-car-crash';
                className = 'traffic-heavy';
                element.style.background = '#f8d7da';
                element.style.color = '#721c24';
            } else if (hour >= 17 && hour <= 20) {
                status = 'Moderate Traffic';
                icon = 'fa-traffic-light';
                className = 'traffic-moderate';
                element.style.background = '#fff3cd';
                element.style.color = '#856404';
            } else {
                status = 'Light Traffic';
                icon = 'fa-car';
                className = 'traffic-light';
                element.style.background = '#d4edda';
                element.style.color = '#155724';
            }
            
            element.innerHTML = `<i class="fas ${icon}"></i> ${status}`;
        }

        function generateUpdates() {
            return [
                { message: 'Order received and confirmed at AS Mart Sindhudurg', time: new Date(Date.now() - 30 * 60000) },
                { message: 'Your items are being packed and prepared', time: new Date(Date.now() - 25 * 60000) },
                { message: 'Order handed over to delivery partner Rajesh Patil', time: new Date(Date.now() - 20 * 60000) },
                { message: 'Delivery partner has picked up your order', time: new Date(Date.now() - 15 * 60000) },
                { message: 'Delivery partner is on the way to your location', time: new Date(Date.now() - 10 * 60000) }
            ];
        }

        function refreshUpdates() {
            const updatesList = document.getElementById('updatesList');
            if (updatesList) {
                const update = {
                    message: 'Tracking data refreshed',
                    time: new Date()
                };
                updatesList.innerHTML = `
                    <div style="padding: 1rem; border-left: 3px solid #ff6b35; background: #f8f9fa; margin-bottom: 0.75rem; border-radius: 0 8px 8px 0;">
                        <div>${update.message}</div>
                        <span style="font-size: 0.8rem; color: #636e72; display: block; margin-top: 0.25rem;">
                            <i class="far fa-clock"></i> Just now
                        </span>
                    </div>
                ` + updatesList.innerHTML;
            }
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - new Date(date);
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min ago`;
            
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            
            return new Date(date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function isElementInViewport(el) {
            if (!el) return false;
            const rect = el.getBoundingClientRect();
            return (
                rect.top >= 0 &&
                rect.left >= 0 &&
                rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
                rect.right <= (window.innerWidth || document.documentElement.clientWidth)
            );
        }

        function setupBasicInteractions() {
            // Basic button actions
            window.callDeliveryBoy = function() {
                if (confirm('Call delivery partner Rajesh Patil?')) {
                    window.open('tel:+919876543210', '_blank');
                }
            };
            
            window.shareLocation = function() {
                if (navigator.share) {
                    navigator.share({
                        title: 'My AS Mart Delivery',
                        text: 'Track my delivery in real-time',
                        url: window.location.href
                    });
                } else {
                    navigator.clipboard.writeText(window.location.href).then(() => {
                        alert('Link copied to clipboard!');
                    });
                }
            };
            
            window.shareTracking = function() {
                if (navigator.share) {
                    navigator.share({
                        title: 'Track my AS Mart Order',
                        text: 'Track my delivery in real-time',
                        url: window.location.href
                    });
                } else {
                    alert('Share this link: ' + window.location.href);
                }
            };
            
            window.markAsDelivered = function() {
                if (confirm('Mark this order as delivered?')) {
                    updateStatus('delivered');
                    alert('Order marked as delivered! Thank you for shopping with AS Mart.');
                }
            };
            
            window.reportIssue = function() {
                const issue = prompt('Please describe the issue:');
                if (issue) {
                    alert('Issue reported. Our team will contact you shortly.');
                }
            };
        }

        // Ensure functions are globally available
        window.sendMessage = sendMessage;
        window.refreshUpdates = refreshUpdates;
    </script>
</body>
</html>