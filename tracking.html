<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Order Tracking - AS Mart</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet CSS for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        .tracking-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        
        .tracking-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }
        
        .tracking-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%23ffffff" fill-opacity="0.1" d="M0,96L48,112C96,128,192,160,288,160C384,160,480,128,576,112C672,96,768,96,864,112C960,128,1056,160,1152,160C1248,160,1344,128,1392,112L1440,96L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>');
            background-size: cover;
        }
        
        .order-info-banner {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }
        
        .info-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            border-left: 4px solid var(--primary);
        }
        
        .tracking-main {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        @media (max-width: 768px) {
            .tracking-main {
                grid-template-columns: 1fr;
            }
        }
        
        /* Map Container */
        #trackingMap {
            height: 400px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 1;
        }
        
        /* Delivery Progress */
        .delivery-progress {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .progress-steps {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin: 1.5rem 0;
        }
        
        .progress-step {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            position: relative;
            transition: all 0.3s;
        }
        
        .progress-step.active {
            background: #e3f2fd;
            border-left: 4px solid var(--primary);
        }
        
        .progress-step.completed {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }
        
        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            background: white;
            color: var(--primary);
            flex-shrink: 0;
        }
        
        .step-icon.completed {
            background: #28a745;
            color: white;
        }
        
        .step-icon.active {
            background: var(--primary);
            color: white;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* Delivery Boy Info */
        .delivery-boy-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .delivery-boy-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--primary);
            font-weight: bold;
            overflow: hidden;
        }
        
        .delivery-boy-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Order Items */
        .order-items-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .item-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 1rem;
            transition: transform 0.3s;
        }
        
        .item-card:hover {
            transform: translateY(-2px);
            background: #e9ecef;
        }
        
        .item-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        
        /* Live Updates */
        .live-updates {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            max-height: 300px;
            overflow-y: auto;
        }
        
        .update-item {
            padding: 1rem;
            border-left: 3px solid var(--primary);
            background: #f8f9fa;
            margin-bottom: 0.75rem;
            border-radius: 0 8px 8px 0;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .update-time {
            font-size: 0.8rem;
            color: #666;
            display: block;
            margin-top: 0.25rem;
        }
        
        /* Stats Cards */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        /* Live Badge */
        .live-badge {
            display: inline-flex;
            align-items: center;
            background: #dc3545;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Control Buttons */
        .control-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }
        
        /* Map Controls */
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .map-btn {
            background: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        
        .map-btn:hover {
            background: #f8f9fa;
            transform: scale(1.1);
        }
        
        /* Loading Animation */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        /* Traffic Status */
        .traffic-status {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .traffic-light { background: #d4edda; color: #155724; }
        .traffic-moderate { background: #fff3cd; color: #856404; }
        .traffic-heavy { background: #f8d7da; color: #721c24; }
        
        /* ETA Display */
        .eta-display {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            margin: 1rem 0;
        }
        
        .eta-time {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }
        
        .eta-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <header>
        <nav class="navbar container">
            <div class="logo">
                <i class="fas fa-bolt"></i>
                <h1>AS <span>Mart</span></h1>
            </div>
            
            <ul class="nav-links">
                <li><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
                <li><a href="shop.html"><i class="fas fa-store"></i> Shop</a></li>
                <li><a href="history.html"><i class="fas fa-history"></i> History</a></li>
                <li><a href="tracking.html" class="active"><i class="fas fa-map-marker-alt"></i> Track</a></li>
                <li><a href="reviews.html"><i class="fas fa-star"></i> Reviews</a></li>
            </ul>
            
            <div class="nav-right">
                <div class="cart-icon" onclick="location.href='cart.html'">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-count">0</span>
                </div>
                <div class="user-profile" id="userProfile">
                    <div class="user-avatar">U</div>
                    <span id="userName">Guest</span>
                </div>
            </div>
        </nav>
    </header>

    <main class="tracking-container">
        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="loading-overlay" style="display: none;">
            <div class="spinner"></div>
        </div>

        <!-- Order Header -->
        <div class="tracking-header">
            <div style="position: relative; z-index: 1;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <div>
                        <h2 style="margin: 0; font-size: 1.8rem;">
                            <i class="fas fa-shipping-fast"></i> Live Order Tracking
                        </h2>
                        <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">
                            Real-time tracking of your delivery
                        </p>
                    </div>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span class="live-badge">
                            <i class="fas fa-circle" style="font-size: 0.5rem; margin-right: 5px;"></i>
                            LIVE
                        </span>
                        <div id="orderStatusBadge" class="order-status status-processing" style="font-size: 0.9rem;">
                            <i class="fas fa-truck"></i> On the Way
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Information Banner -->
        <div class="order-info-banner">
            <div class="info-card">
                <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.25rem;">
                    <i class="fas fa-receipt"></i> Order Number
                </div>
                <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary);" id="orderNumber">
                    #ASMART001
                </div>
            </div>
            
            <div class="info-card">
                <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.25rem;">
                    <i class="fas fa-clock"></i> Order Time
                </div>
                <div style="font-size: 1.1rem; font-weight: 600;" id="orderTime">
                    10:30 AM, Today
                </div>
            </div>
            
            <div class="info-card">
                <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.25rem;">
                    <i class="fas fa-map-marker-alt"></i> Delivery To
                </div>
                <div style="font-size: 1.1rem; font-weight: 600;" id="deliveryAddress">
                    Your Address
                </div>
            </div>
            
            <div class="info-card">
                <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.25rem;">
                    <i class="fas fa-credit-card"></i> Payment
                </div>
                <div style="font-size: 1.1rem; font-weight: 600;" id="paymentMethod">
                    Cash on Delivery
                </div>
            </div>
        </div>

        <!-- Main Tracking Area -->
        <div class="tracking-main">
            <!-- Left Column: Map -->
            <div>
                <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                    <h3><i class="fas fa-map"></i> Live Delivery Route</h3>
                    <div id="trafficStatus" class="traffic-status traffic-moderate">
                        <i class="fas fa-traffic-light"></i> Moderate Traffic
                    </div>
                </div>
                
                <div style="position: relative;">
                    <div id="trackingMap"></div>
                    <div class="map-controls">
                        <button class="map-btn" onclick="centerMap()" title="Center Map">
                            <i class="fas fa-crosshairs"></i>
                        </button>
                        <button class="map-btn" onclick="zoomIn()" title="Zoom In">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="map-btn" onclick="zoomOut()" title="Zoom Out">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
                
                <!-- ETA Display -->
                <div class="eta-display">
                    <div class="eta-label">Estimated Delivery Time</div>
                    <div class="eta-time" id="etaTime">15 min</div>
                    <div class="eta-label">Based on current traffic and location</div>
                </div>
            </div>
            
            <!-- Right Column: Delivery Progress -->
            <div class="delivery-progress">
                <h3><i class="fas fa-list-ol"></i> Delivery Status</h3>
                <div class="progress-steps">
                    <div class="progress-step completed">
                        <div class="step-icon completed">
                            <i class="fas fa-check"></i>
                        </div>
                        <div>
                            <div style="font-weight: 600;">Order Confirmed</div>
                            <div style="font-size: 0.8rem; color: #666;">Order received and confirmed</div>
                        </div>
                    </div>
                    
                    <div class="progress-step completed">
                        <div class="step-icon completed">
                            <i class="fas fa-check"></i>
                        </div>
                        <div>
                            <div style="font-weight: 600;">Preparing Order</div>
                            <div style="font-size: 0.8rem; color: #666;">Items are being packed</div>
                        </div>
                    </div>
                    
                    <div class="progress-step active">
                        <div class="step-icon active">
                            <i class="fas fa-truck"></i>
                        </div>
                        <div>
                            <div style="font-weight: 600;">On the Way</div>
                            <div style="font-size: 0.8rem; color: #666;">Delivery partner is on the way</div>
                        </div>
                    </div>
                    
                    <div class="progress-step">
                        <div class="step-icon">
                            <i class="fas fa-home"></i>
                        </div>
                        <div>
                            <div style="font-weight: 600;">Nearby</div>
                            <div style="font-size: 0.8rem; color: #666;">Delivery partner is nearby</div>
                        </div>
                    </div>
                    
                    <div class="progress-step">
                        <div class="step-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div>
                            <div style="font-weight: 600;">Delivered</div>
                            <div style="font-size: 0.8rem; color: #666;">Order delivered successfully</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Row -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-value" id="distance">2.5 km</div>
                <div class="stat-label">Distance Remaining</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-value" id="currentSpeed">25 km/h</div>
                <div class="stat-label">Current Speed</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-value" id="deliveryBoyRating">4.8</div>
                <div class="stat-label">Delivery Partner Rating</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-value" id="itemsCount">5</div>
                <div class="stat-label">Items in Order</div>
            </div>
        </div>

        <!-- Delivery Boy Information -->
        <div class="delivery-boy-card">
            <div class="delivery-boy-avatar">
                <i class="fas fa-user"></i>
            </div>
            <div style="flex: 1;">
                <h3 style="margin: 0 0 0.5rem 0;">Your Delivery Partner</h3>
                <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                    <div>
                        <div style="font-weight: 600; font-size: 1.2rem;" id="deliveryBoyName">Rajesh Kumar</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;" id="deliveryBoyId">ID: DLV-4567</div>
                    </div>
                    <div>
                        <div style="font-weight: 600;" id="deliveryBoyPhone">
                            <i class="fas fa-phone"></i> +91 98765 43210
                        </div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">
                            <i class="fas fa-motorcycle"></i> Bike Delivery
                        </div>
                    </div>
                </div>
            </div>
            <button class="btn btn-light" onclick="callDeliveryBoy()" style="white-space: nowrap;">
                <i class="fas fa-phone"></i> Call Now
            </button>
        </div>

        <!-- Order Items & Live Updates -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <!-- Order Items -->
            <div class="order-items-card">
                <h3><i class="fas fa-shopping-bag"></i> Order Items</h3>
                <div id="orderItemsList">
                    <!-- Items will be loaded here -->
                </div>
            </div>
            
            <!-- Live Updates -->
            <div class="live-updates">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="margin: 0;"><i class="fas fa-broadcast-tower"></i> Live Updates</h3>
                    <button class="btn btn-sm" onclick="refreshUpdates()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div id="updatesList">
                    <!-- Updates will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Control Buttons -->
        <div class="control-buttons">
            <button class="btn btn-primary" onclick="shareTracking()">
                <i class="fas fa-share-alt"></i> Share Tracking
            </button>
            <button class="btn btn-secondary" onclick="viewOrderDetails()">
                <i class="fas fa-file-invoice"></i> View Order Details
            </button>
            <button class="btn btn-success" onclick="markAsDelivered()">
                <i class="fas fa-check-circle"></i> Mark as Delivered
            </button>
            <button class="btn btn-danger" onclick="reportIssue()">
                <i class="fas fa-exclamation-triangle"></i> Report Issue
            </button>
        </div>
    </main>

    <!-- Share Modal -->
    <div id="shareModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <h3 style="margin: 0; color: white;"><i class="fas fa-share-alt"></i> Share Tracking</h3>
                <span class="close-modal" onclick="closeModal('shareModal')">&times;</span>
            </div>
            <div class="modal-body">
                <p>Share this tracking link with friends and family:</p>
                <div style="display: flex; gap: 0.5rem; margin: 1rem 0;">
                    <input type="text" id="trackingLink" readonly 
                           style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;" 
                           value="https://asmart.com/track/ASMART001">
                    <button class="btn" onclick="copyTrackingLink()">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1rem;">
                    <button class="btn" style="background: #25D366; color: white;" onclick="shareWhatsApp()">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </button>
                    <button class="btn" style="background: #1877F2; color: white;" onclick="shareFacebook()">
                        <i class="fab fa-facebook"></i> Facebook
                    </button>
                    <button class="btn" style="background: #1DA1F2; color: white;" onclick="shareTwitter()">
                        <i class="fab fa-twitter"></i> Twitter
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>AS Mart</h3>
                    <p>Your trusted 20-minute delivery partner for all daily needs.</p>
                </div>
                <div class="footer-section">
                    <h3>Quick Links</h3>
                    <ul class="footer-links">
                        <li><a href="shop.html">Shop Now</a></li>
                        <li><a href="history.html">Order History</a></li>
                        <li><a href="tracking.html">Track Order</a></li>
                        <li><a href="reviews.html">Leave Review</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Contact Us</h3>
                    <p><i class="fas fa-phone"></i> +1 234 567 890</p>
                    <p><i class="fas fa-envelope"></i> support@asmart.com</p>
                </div>
            </div>
            <div class="copyright">
                <p>&copy; 2024 AS Mart. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Global variables
        let map;
        let deliveryMarker;
        let userMarker;
        let routeLine;
        let watchId = null;
        let deliveryBoyLocation = { lat: 28.6139, lng: 77.2090 }; // Default: Delhi
        let userLocation = { lat: 28.6219, lng: 77.2110 }; // Default: Nearby Delhi
        let orderData = {};
        let updateInterval;

        // Initialize tracking page
        document.addEventListener('DOMContentLoaded', function() {
            initializeTracking();
        });

        function initializeTracking() {
            showLoading();
            
            // Get order data from localStorage or URL parameters
            loadOrderData();
            
            // Initialize map
            initializeMap();
            
            // Load order details
            loadOrderDetails();
            
            // Start live updates
            startLiveTracking();
            
            // Set up periodic updates
            updateInterval = setInterval(updateTrackingData, 30000); // Update every 30 seconds
            
            // Hide loading after 1.5 seconds
            setTimeout(hideLoading, 1500);
            
            // Update cart count
            updateCartCount();
        }

        function loadOrderData() {
            // Try to get order from localStorage first
            const savedOrder = localStorage.getItem('currentTrackingOrder');
            if (savedOrder) {
                orderData.orderNumber = savedOrder;
            }
            
            // Try to get from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const orderParam = urlParams.get('order');
            if (orderParam) {
                orderData.orderNumber = orderParam;
                localStorage.setItem('currentTrackingOrder', orderParam);
            }
            
            // If no order specified, try to get latest order
            if (!orderData.orderNumber) {
                const orders = JSON.parse(localStorage.getItem('asmart_user_orders') || '[]');
                if (orders.length > 0) {
                    orderData.orderNumber = orders[0].orderNumber;
                } else {
                    // Use default demo order
                    orderData.orderNumber = 'ASMART001';
                }
            }
        }

        function initializeMap() {
            // Initialize map centered on user location
            map = L.map('trackingMap').setView([userLocation.lat, userLocation.lng], 14);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            // Add custom tile layer for better visualization
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '© CARTO'
            }).addTo(map);
            
            // Add user marker (delivery destination)
            userMarker = L.marker([userLocation.lat, userLocation.lng], {
                icon: L.divIcon({
                    className: 'user-marker',
                    html: '<div style="background: #007bff; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3);"><i class="fas fa-home"></i></div>',
                    iconSize: [30, 30]
                })
            }).addTo(map);
            
            // Add delivery boy marker
            deliveryMarker = L.marker([deliveryBoyLocation.lat, deliveryBoyLocation.lng], {
                icon: L.divIcon({
                    className: 'delivery-marker',
                    html: '<div style="background: #28a745; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3); animation: pulse 2s infinite;"><i class="fas fa-motorcycle"></i></div>',
                    iconSize: [40, 40]
                })
            }).addTo(map);
            
            // Draw route line
            updateRoute();
            
            // Fit map to show both markers
            const bounds = L.latLngBounds([deliveryBoyLocation, userLocation]);
            map.fitBounds(bounds, { padding: [50, 50] });
        }

        function updateRoute() {
            // Remove existing route if any
            if (routeLine) {
                map.removeLayer(routeLine);
            }
            
            // Create a simple curved route
            const routePoints = [
                [deliveryBoyLocation.lat, deliveryBoyLocation.lng],
                [
                    (deliveryBoyLocation.lat + userLocation.lat) / 2 + 0.01,
                    (deliveryBoyLocation.lng + userLocation.lng) / 2 + 0.01
                ],
                [userLocation.lat, userLocation.lng]
            ];
            
            routeLine = L.polyline(routePoints, {
                color: '#007bff',
                weight: 4,
                opacity: 0.7,
                dashArray: '10, 10'
            }).addTo(map);
        }

        function loadOrderDetails() {
            // Load order details from localStorage or use demo data
            const orders = JSON.parse(localStorage.getItem('asmart_user_orders') || '[]');
            let order = orders.find(o => o.orderNumber === orderData.orderNumber);
            
            if (!order) {
                // Create demo order data
                order = {
                    orderNumber: orderData.orderNumber,
                    customerName: localStorage.getItem('userName') || 'Customer',
                    customerPhone: localStorage.getItem('userPhone') || '+91 98765 43210',
                    deliveryAddress: localStorage.getItem('userAddress') || '123 Main Street, New Delhi 110001',
                    items: [
                        { name: 'Fresh Apples', category: 'fruits', price: 2.99, quantity: 3 },
                        { name: 'Whole Milk', category: 'dairy', price: 3.49, quantity: 2 },
                        { name: 'Brown Bread', category: 'bakery', price: 1.99, quantity: 1 },
                        { name: 'Potato Chips', category: 'snacks', price: 2.49, quantity: 2 },
                        { name: 'Orange Juice', category: 'beverages', price: 3.99, quantity: 1 }
                    ],
                    total: 27.42,
                    paymentMethod: 'Cash on Delivery',
                    status: 'On the Way',
                    date: new Date().toISOString()
                };
            }
            
            // Update UI with order details
            document.getElementById('orderNumber').textContent = `#${order.orderNumber}`;
            document.getElementById('orderTime').textContent = new Date(order.date).toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit'
            }) + ', Today';
            document.getElementById('deliveryAddress').textContent = order.deliveryAddress;
            document.getElementById('paymentMethod').textContent = order.paymentMethod;
            document.getElementById('itemsCount').textContent = order.items ? order.items.length : 0;
            
            // Update order status badge
            updateStatusBadge(order.status);
            
            // Load order items
            loadOrderItems(order.items);
            
            // Generate live updates
            generateLiveUpdates();
            
            // Calculate and update distance
            updateDistanceAndETA();
        }

        function updateStatusBadge(status) {
            const badge = document.getElementById('orderStatusBadge');
            badge.className = `order-status status-${status.toLowerCase().replace(' ', '')}`;
            
            let icon = 'fa-clock';
            let text = status;
            
            switch(status.toLowerCase()) {
                case 'pending':
                    icon = 'fa-clock';
                    break;
                case 'processing':
                    icon = 'fa-cog';
                    break;
                case 'on the way':
                    icon = 'fa-truck';
                    break;
                case 'delivered':
                    icon = 'fa-check-circle';
                    break;
                case 'cancelled':
                    icon = 'fa-times-circle';
                    break;
            }
            
            badge.innerHTML = `<i class="fas ${icon}"></i> ${text}`;
        }

        function loadOrderItems(items) {
            const container = document.getElementById('orderItemsList');
            if (!items || items.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center;">No items in this order</p>';
                return;
            }
            
            container.innerHTML = items.map(item => `
                <div class="item-card">
                    <div class="item-image" style="background: ${getCategoryColor(item.category)};">
                        ${getCategoryIcon(item.category)}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; margin-bottom: 0.25rem;">${item.name}</div>
                        <div style="font-size: 0.9rem; color: #666;">
                            Quantity: ${item.quantity} × ₹${item.price.toFixed(2)}
                        </div>
                    </div>
                    <div style="font-weight: bold; color: var(--primary);">
                        ₹${(item.price * item.quantity).toFixed(2)}
                    </div>
                </div>
            `).join('');
        }

        function getCategoryColor(category) {
            const colors = {
                'fruits': '#28a745',
                'vegetables': '#20c997',
                'dairy': '#ffc107',
                'meat': '#dc3545',
                'bakery': '#e83e8c',
                'beverages': '#17a2b8',
                'snacks': '#6f42c1',
                'electronics': '#007bff',
                'home': '#fd7e14'
            };
            return colors[category.toLowerCase()] || '#667eea';
        }

        function getCategoryIcon(category) {
            const icons = {
                'fruits': '<i class="fas fa-apple-alt"></i>',
                'vegetables': '<i class="fas fa-carrot"></i>',
                'dairy': '<i class="fas fa-cheese"></i>',
                'meat': '<i class="fas fa-drumstick-bite"></i>',
                'bakery': '<i class="fas fa-bread-slice"></i>',
                'beverages': '<i class="fas fa-wine-bottle"></i>',
                'snacks': '<i class="fas fa-cookie"></i>',
                'electronics': '<i class="fas fa-laptop"></i>',
                'home': '<i class="fas fa-home"></i>'
            };
            return icons[category.toLowerCase()] || '<i class="fas fa-shopping-bag"></i>';
        }

        function startLiveTracking() {
            // Simulate live location updates for delivery boy
            if (watchId) {
                clearInterval(watchId);
            }
            
            watchId = setInterval(() => {
                simulateDeliveryBoyMovement();
                updateTrackingData();
            }, 10000); // Update every 10 seconds
            
            // Also track user's location if permitted
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        if (userMarker) {
                            userMarker.setLatLng([userLocation.lat, userLocation.lng]);
                        }
                        updateRoute();
                        updateDistanceAndETA();
                    },
                    (error) => {
                        console.log('Location access denied, using default location');
                    },
                    { enableHighAccuracy: true, maximumAge: 10000, timeout: 5000 }
                );
            }
        }

        function simulateDeliveryBoyMovement() {
            // Simulate delivery boy moving toward user location
            const speed = 0.0001; // Degrees per update
            const dx = userLocation.lat - deliveryBoyLocation.lat;
            const dy = userLocation.lng - deliveryBoyLocation.lng;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance > 0.0005) { // Don't move if very close
                deliveryBoyLocation.lat += (dx / distance) * speed;
                deliveryBoyLocation.lng += (dy / distance) * speed;
                
                // Update marker position
                deliveryMarker.setLatLng([deliveryBoyLocation.lat, deliveryBoyLocation.lng]);
                
                // Update route
                updateRoute();
                
                // Add live update
                addLiveUpdate(`Delivery partner is on the move - getting closer to your location`);
            }
        }

        function updateTrackingData() {
            // Update distance and ETA
            updateDistanceAndETA();
            
            // Update speed (simulated)
            const speed = 25 + Math.random() * 10; // 25-35 km/h
            document.getElementById('currentSpeed').textContent = `${Math.round(speed)} km/h`;
            
            // Update traffic status randomly
            updateTrafficStatus();
            
            // Update delivery progress based on distance
            updateDeliveryProgress();
        }

        function updateDistanceAndETA() {
            // Calculate distance between delivery boy and user
            const latDiff = userLocation.lat - deliveryBoyLocation.lat;
            const lngDiff = userLocation.lng - deliveryBoyLocation.lng;
            const distanceDeg = Math.sqrt(latDiff * latDiff + lngDiff * lngDiff);
            
            // Convert degrees to kilometers (approx)
            const distanceKm = distanceDeg * 111;
            
            // Update distance display
            document.getElementById('distance').textContent = `${distanceKm.toFixed(1)} km`;
            
            // Calculate ETA (assuming average speed of 30 km/h)
            const etaMinutes = Math.round((distanceKm / 30) * 60);
            
            // Update ETA display
            const etaElement = document.getElementById('etaTime');
            if (etaMinutes < 1) {
                etaElement.textContent = '< 1 min';
            } else if (etaMinutes < 60) {
                etaElement.textContent = `${etaMinutes} min`;
            } else {
                const hours = Math.floor(etaMinutes / 60);
                const minutes = etaMinutes % 60;
                etaElement.textContent = `${hours}h ${minutes}m`;
            }
        }

        function updateTrafficStatus() {
            const statuses = ['traffic-light', 'traffic-moderate', 'traffic-heavy'];
            const labels = ['Light Traffic', 'Moderate Traffic', 'Heavy Traffic'];
            const icons = ['fa-car', 'fa-traffic-light', 'fa-car-crash'];
            
            // Randomly change traffic status for demo
            const randomIndex = Math.floor(Math.random() * statuses.length);
            const trafficElement = document.getElementById('trafficStatus');
            
            trafficElement.className = `traffic-status ${statuses[randomIndex]}`;
            trafficElement.innerHTML = `<i class="fas ${icons[randomIndex]}"></i> ${labels[randomIndex]}`;
        }

        function updateDeliveryProgress() {
            const steps = document.querySelectorAll('.progress-step');
            const distance = parseFloat(document.getElementById('distance').textContent);
            
            // Update progress based on distance
            steps.forEach((step, index) => {
                step.classList.remove('active', 'completed');
                const stepIcon = step.querySelector('.step-icon');
                stepIcon.classList.remove('active', 'completed');
                
                if (index < 2) {
                    // First two steps are always completed
                    step.classList.add('completed');
                    stepIcon.classList.add('completed');
                } else if (index === 2 && distance > 0.5) {
                    // On the way if distance > 0.5km
                    step.classList.add('active');
                    stepIcon.classList.add('active');
                } else if (index === 3 && distance <= 0.5 && distance > 0.1) {
                    // Nearby if distance <= 0.5km
                    step.classList.add('active');
                    stepIcon.classList.add('active');
                } else if (index === 4 && distance <= 0.1) {
                    // Delivered if very close
                    step.classList.add('active');
                    stepIcon.classList.add('active');
                }
            });
        }

        function generateLiveUpdates() {
            const updates = [
                { time: '10:30 AM', message: 'Order confirmed and received by AS Mart' },
                { time: '10:45 AM', message: 'Order is being prepared and packed' },
                { time: '11:00 AM', message: 'Order handed over to delivery partner Rajesh' },
                { time: '11:15 AM', message: 'Delivery partner has picked up your order' },
                { time: '11:30 AM', message: 'Delivery partner is on the way to your location' },
                { time: 'Just now', message: 'Delivery partner is approaching your area' }
            ];
            
            const container = document.getElementById('updatesList');
            container.innerHTML = updates.map(update => `
                <div class="update-item">
                    <div>${update.message}</div>
                    <span class="update-time">
                        <i class="far fa-clock"></i> ${update.time}
                    </span>
                </div>
            `).reverse().join(''); // Show newest first
        }

        function addLiveUpdate(message) {
            const container = document.getElementById('updatesList');
            const updateItem = document.createElement('div');
            updateItem.className = 'update-item';
            updateItem.innerHTML = `
                <div>${message}</div>
                <span class="update-time">
                    <i class="far fa-clock"></i> Just now
                </span>
            `;
            
            // Add to top
            container.insertBefore(updateItem, container.firstChild);
            
            // Keep only last 10 updates
            const updates = container.querySelectorAll('.update-item');
            if (updates.length > 10) {
                container.removeChild(updates[updates.length - 1]);
            }
        }

        // Map Controls
        function centerMap() {
            const bounds = L.latLngBounds([deliveryBoyLocation, userLocation]);
            map.fitBounds(bounds, { padding: [50, 50] });
        }

        function zoomIn() {
            map.zoomIn();
        }

        function zoomOut() {
            map.zoomOut();
        }

        // Action Functions
        function callDeliveryBoy() {
            const phone = document.getElementById('deliveryBoyPhone').textContent.match(/\d+/g)?.join('');
            if (phone) {
                window.open(`tel:${phone}`, '_blank');
            } else {
                alert('Phone number not available');
            }
        }

        function shareTracking() {
            document.getElementById('shareModal').style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function copyTrackingLink() {
            const linkInput = document.getElementById('trackingLink');
            linkInput.select();
            document.execCommand('copy');
            alert('Tracking link copied to clipboard!');
        }

        function shareWhatsApp() {
            const text = `Track my AS Mart order #${orderData.orderNumber}: ${window.location.href}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }

        function shareFacebook() {
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}`, '_blank');
        }

        function shareTwitter() {
            const text = `Tracking my AS Mart order #${orderData.orderNumber}`;
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(window.location.href)}`, '_blank');
        }

        function viewOrderDetails() {
            // Navigate to order details or show in modal
            alert('Order details feature would show complete order information');
        }

        function markAsDelivered() {
            if (confirm('Mark this order as delivered?')) {
                // Update order status
                updateStatusBadge('Delivered');
                addLiveUpdate('Order marked as delivered by customer');
                
                // Show success message
                alert('Order marked as delivered! Thank you for shopping with AS Mart.');
            }
        }

        function reportIssue() {
            const issue = prompt('Please describe the issue:');
            if (issue) {
                addLiveUpdate(`Issue reported: ${issue}`);
                alert('Issue reported. Our team will contact you shortly.');
            }
        }

        function refreshUpdates() {
            generateLiveUpdates();
            showNotification('Live updates refreshed!', 'success');
        }

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function updateCartCount() {
            const cart = JSON.parse(localStorage.getItem('asmartCart') || '[]');
            const count = cart.reduce((total, item) => total + (item.quantity || 1), 0);
            document.querySelector('.cart-count').textContent = count;
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
                <button onclick="this.parentElement.remove()" style="background: none; border: none; cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            // Add styles if not already present
            if (!document.querySelector('#notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    .notification {
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: white;
                        padding: 15px 20px;
                        border-radius: 8px;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        z-index: 10000;
                        animation: slideInRight 0.3s ease-out;
                        min-width: 300px;
                    }
                    .notification-success {
                        border-left: 4px solid #28a745;
                    }
                    .notification-info {
                        border-left: 4px solid #17a2b8;
                    }
                    @keyframes slideInRight {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 3000);
        }

        // Clean up on page unload
        window.addEventListener('beforeunload', function() {
            if (watchId) {
                clearInterval(watchId);
            }
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html>