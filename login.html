<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - AS Mart</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Keeping your existing styles */
        :root { --primary: #ffcc00; --primary-light: #fff0b3; --dark: #333; }
        .auth-container { max-width: 500px; margin: 4rem auto; padding: 2rem; background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .auth-header { text-align: center; margin-bottom: 2rem; }
        .auth-logo { display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 1.5rem; }
        .auth-logo i { font-size: 3rem; color: var(--primary); }
        .auth-logo h1 { font-size: 2.5rem; margin: 0; }
        .auth-tabs { display: flex; border-bottom: 2px solid #eee; margin-bottom: 2rem; }
        .auth-tab { flex: 1; padding: 1rem; text-align: center; background: none; border: none; font-size: 1.1rem; font-weight: 600; color: #666; cursor: pointer; transition: all 0.3s; position: relative; }
        .auth-tab.active { color: var(--primary); }
        .auth-tab.active::after { content: ''; position: absolute; bottom: -2px; left: 0; right: 0; height: 3px; background: var(--primary); border-radius: 3px; }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .role-selection { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; }
        .role-option { padding: 1rem; border: 2px solid #e0e0e0; border-radius: 10px; text-align: center; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 0.5rem; }
        .role-option.selected { border-color: var(--primary); background: rgba(255, 204, 0, 0.1); }
        .role-icon { font-size: 2rem; color: var(--primary); }
        .form-footer { text-align: center; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #eee; font-size: 0.9rem; color: #666; }
        .error-message { background: #ffebee; color: #c62828; padding: 0.8rem 1rem; border-radius: 8px; margin-bottom: 1rem; display: none; border-left: 4px solid #c62828; }
        .success-message { background: #e8f5e9; color: #2e7d32; padding: 0.8rem 1rem; border-radius: 8px; margin-bottom: 1rem; display: none; border-left: 4px solid #2e7d32; }
        .input-with-icon { position: relative; }
        .input-with-icon i { position: absolute; left: 15px; top: 15px; color: #999; }
        .input-with-icon input, .input-with-icon textarea, .input-with-icon select { padding-left: 45px !important; width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; }
        .btn-block { width: 100%; padding: 12px; background: var(--primary); border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .toggle-password { position: absolute; right: 15px; top: 12px; border: none; background: none; cursor: pointer; }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="auth-header">
            <div class="auth-logo">
                <i class="fas fa-bolt"></i>
                <h1>AS <span style="color: #ffcc00;">Mart</span></h1>
            </div>
            <p style="color: #666; font-size: 1.1rem;">Your 20-minute delivery partner</p>
        </div>
        
        <div class="auth-tabs">
            <button class="auth-tab active" id="tab-login" onclick="switchTab('login')">Login</button>
            <button class="auth-tab" id="tab-register" onclick="switchTab('register')">Register</button>
        </div>
        
        <!-- Login Form -->
        <div id="loginForm" class="auth-form active">
            <div class="error-message" id="loginError"></div>
            <div class="success-message" id="loginSuccess"></div>
            <form onsubmit="handleLogin(event)">
                <div class="input-with-icon">
                    <i class="fas fa-envelope"></i>
                    <input type="email" id="loginEmail" required placeholder="Email Address">
                </div>
                <div class="input-with-icon">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="loginPassword" required placeholder="Password">
                    <button type="button" class="toggle-password" onclick="togglePassword('loginPassword')"><i class="fas fa-eye"></i></button>
                </div>
                <button type="submit" class="btn-block">Sign In</button>
            </form>
            <div class="form-footer">Don't have an account? <a href="#" onclick="switchTab('register')">Sign up</a></div>
        </div>
        
        <!-- Register Form -->
        <div id="registerForm" class="auth-form">
            <div class="error-message" id="registerError"></div>
            <div class="success-message" id="registerSuccess"></div>
            <form onsubmit="handleRegister(event)">
                <div class="role-selection">
                    <div class="role-option selected" onclick="selectRole('customer')" id="customerRole">
                        <i class="fas fa-user role-icon"></i><span>Customer</span>
                    </div>
                    <div class="role-option" onclick="selectRole('host')" id="hostRole">
                        <i class="fas fa-store role-icon"></i><span>Host</span>
                    </div>
                </div>
                <input type="hidden" id="userRole" value="customer">

                <div class="input-with-icon"><i class="fas fa-user"></i><input type="text" id="registerName" required placeholder="Full Name"></div>
                <div class="input-with-icon"><i class="fas fa-envelope"></i><input type="email" id="registerEmail" required placeholder="Email"></div>
                <div class="input-with-icon"><i class="fas fa-phone"></i><input type="tel" id="registerPhone" required placeholder="Phone Number"></div>
                <div class="input-with-icon"><i class="fas fa-map-marker-alt"></i><textarea id="registerAddress" placeholder="Home Address"></textarea></div>

                <!-- Shop details (only for hosts) -->
                <div id="shopDetails" style="display: none;">
                    <div class="input-with-icon"><i class="fas fa-signature"></i><input type="text" id="shopName" placeholder="Shop Name"></div>
                    <div class="input-with-icon"><i class="fas fa-tag"></i>
                        <select id="shopType">
                            <option value="">Select Shop Type</option>
                            <option value="Grocery">Grocery</option>
                            <option value="Bakery">Bakery</option>
                        </select>
                    </div>
                </div>

                <div class="input-with-icon"><i class="fas fa-lock"></i><input type="password" id="registerPassword" required placeholder="Password (min 6 chars)"></div>
                <button type="submit" class="btn-block">Create Account</button>
            </form>
        </div>
    </div>

    <!-- 1. FIREBASE SDKS (Namespaced version 8 for compatibility) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // 2. FIREBASE CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyDw1RHr6fmnC5opJ5j87sRwQNxMDAYA-Ug",
            authDomain: "asmart-70cfc.firebaseapp.com",
            projectId: "asmart-70cfc",
            storageBucket: "asmart-70cfc.firebasestorage.app",
            messagingSenderId: "631864173433",
            appId: "1:631864173433:web:0be2ebbd828c62555505a8",
            measurementId: "G-Q62833ET3Y"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // UI Logic
        function switchTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            if (tab === 'login') {
                document.getElementById('tab-login').classList.add('active');
                document.getElementById('loginForm').classList.add('active');
            } else {
                document.getElementById('tab-register').classList.add('active');
                document.getElementById('registerForm').classList.add('active');
            }
        }

        function selectRole(role) {
            document.getElementById('customerRole').classList.toggle('selected', role === 'customer');
            document.getElementById('hostRole').classList.toggle('selected', role === 'host');
            document.getElementById('shopDetails').style.display = role === 'host' ? 'block' : 'none';
            document.getElementById('userRole').value = role;
        }

        function togglePassword(id) {
            const input = document.getElementById(id);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function showMsg(id, msg, isError = true) {
            const el = document.getElementById(id);
            el.textContent = msg;
            el.style.display = 'block';
            el.style.backgroundColor = isError ? '#ffebee' : '#e8f5e9';
            el.style.color = isError ? '#c62828' : '#2e7d32';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        // 3. AUTHENTICATION LOGIC (ASYNCHRONOUS)
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const userDoc = await db.collection('users').doc(userCredential.user.uid).get();
                const userData = userDoc.data();

                showMsg('loginSuccess', 'Login successful! Redirecting...', false);
                
                setTimeout(() => {
                    if (userData && userData.role === 'host') window.location.href = 'index.html';
                    else window.location.href = 'index.html';
                }, 1500);
            } catch (error) {
                showMsg('loginError', error.message);
            }
        }

        async function handleRegister(event) {
            event.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const role = document.getElementById('userRole').value;
            const phone = document.getElementById('registerPhone').value;
            const address = document.getElementById('registerAddress').value;

            try {
                // 1. Create user in Firebase Auth
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const uid = userCredential.user.uid;

                // 2. Prepare user profile data
                const userData = {
                    uid: uid,
                    name: name,
                    email: email,
                    role: role,
                    phone: phone,
                    address: address,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // 3. Add Shop details if role is Host
                if (role === 'host') {
                    userData.shopName = document.getElementById('shopName').value;
                    userData.shopType = document.getElementById('shopType').value;
                }

                // 4. Save to Firestore
                await db.collection('users').doc(uid).set(userData);

                showMsg('registerSuccess', 'Account created! Switching to login...', false);
                setTimeout(() => switchTab('login'), 2000);
            } catch (error) {
                showMsg('registerError', error.message);
            }
        }

        // Helper: Check if already logged in
        auth.onAuthStateChanged(user => {
            if (user && window.location.pathname.includes('login.html')) {
                // Optionally auto-redirect if already logged in
            }
        });
    </script>
</body>
</html>