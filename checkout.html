<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - AS Mart</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-radius: 12px 12px 0 0;
        }
        
        .modal-body {
            padding: 30px 20px;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .close-modal {
            font-size: 28px;
            cursor: pointer;
            color: white;
            opacity: 0.8;
        }
        
        .close-modal:hover {
            opacity: 1;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .success-icon {
            font-size: 80px;
            color: #28a745;
            margin-bottom: 20px;
        }
        
        .order-summary-box {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            border-left: 4px solid #28a745;
        }
        
        /* Timer warning */
        .timer-warning {
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Checkout specific styles */
        .checkout-container {
            display: grid;
            grid-template-columns: 1.2fr 0.8fr;
            gap: 2rem;
            margin: 2rem 0;
        }
        
        .address-form, .cart-summary {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .payment-method {
            text-align: center;
            padding: 1.5rem 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .payment-method.active {
            border-color: #3498db;
            background: #f0f8ff;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
        }
        
        .payment-method:hover {
            border-color: #3498db;
            transform: translateY(-2px);
        }
        
        .payment-method i {
            color: #3498db;
            margin-bottom: 0.5rem;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .summary-item.total {
            border-top: 2px solid #ddd;
            font-weight: bold;
            font-size: 1.2rem;
            color: #2c3e50;
        }
        
        #paymentTimer {
            text-align: center;
            font-size: 2rem;
            font-weight: bold;
            color: #28a745;
            margin: 1rem 0;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .checkout-container {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                margin: 10px;
            }
            
            .modal-footer {
                flex-direction: column;
            }
            
            .modal-footer button {
                width: 100%;
            }
            
            .payment-methods {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <nav class="navbar container">
            <div class="logo">
                <i class="fas fa-bolt"></i>
                <h1>AS <span>Mart</span></h1>
            </div>
            
            <ul class="nav-links">
                <li><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
                <li><a href="shop.html"><i class="fas fa-store"></i> Shop</a></li>
                <li><a href="history.html"><i class="fas fa-history"></i> Orders</a></li>
                <li><a href="tracking.html"><i class="fas fa-map-marker-alt"></i> Track</a></li>
                <li><a href="reviews.html"><i class="fas fa-star"></i> Reviews</a></li>
            </ul>
            
            <div class="nav-right">
                <div class="cart-icon" onclick="location.href='cart.html'">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-count">0</span>
                </div>
                <div class="user-profile" id="userProfile">
                    <div class="user-avatar">U</div>
                    <span>Guest</span>
                </div>
            </div>
        </nav>
    </header>

    <main class="container">
        <h2 class="section-title" style="margin: 2rem 0;"><i class="fas fa-lock"></i> Secure Checkout</h2>
        
        <div class="timer" id="paymentTimer">
            05:00
        </div>
        <p style="text-align: center; color: var(--primary); margin-bottom: 2rem;">
            Complete your payment within 5 minutes to secure your 20-minute delivery
        </p>
        
        <div class="checkout-container">
            <div class="address-form">
                <h3><i class="fas fa-map-marker-alt"></i> Delivery Address</h3>
                <form id="addressForm">
                    <div class="form-group">
                        <label>Full Name *</label>
                        <input type="text" class="form-control" id="fullName" required placeholder="Enter your full name">
                    </div>
                    <div class="form-group">
                        <label>Phone Number *</label>
                        <input type="tel" class="form-control" id="phone" required placeholder="10-digit phone number">
                    </div>
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" class="form-control" id="email" placeholder="email@example.com">
                    </div>
                    <div class="form-group">
                        <label>Complete Address *</label>
                        <textarea class="form-control" id="address" rows="3" required placeholder="House no., Street, Area, Landmark"></textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>City *</label>
                            <input type="text" class="form-control" id="city" required placeholder="Your city">
                        </div>
                        <div class="form-group">
                            <label>Pincode *</label>
                            <input type="text" class="form-control" id="pincode" required placeholder="6-digit pincode">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Delivery Instructions (Optional)</label>
                        <textarea class="form-control" id="instructions" rows="2" placeholder="Any special instructions for delivery"></textarea>
                    </div>
                </form>
                
                <h3 style="margin-top: 2rem;"><i class="fas fa-credit-card"></i> Payment Method</h3>
                <div class="payment-methods">
                    <div class="payment-method active" onclick="selectPayment('cash')">
                        <i class="fas fa-money-bill-wave fa-2x"></i>
                        <p>Cash on Delivery</p>
                    </div>
                    <div class="payment-method" onclick="selectPayment('card')">
                        <i class="fas fa-credit-card fa-2x"></i>
                        <p>Card Payment</p>
                    </div>
                    <div class="payment-method" onclick="selectPayment('upi')">
                        <i class="fas fa-mobile-alt fa-2x"></i>
                        <p>UPI</p>
                    </div>
                </div>
                
                <!-- Card Details (shown when card is selected) -->
                <div id="cardDetails" style="margin-top: 2rem; display: none;">
                    <div class="form-group">
                        <label>Card Number</label>
                        <input type="text" class="form-control" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Expiry Date</label>
                            <input type="text" class="form-control" id="expiry" placeholder="MM/YY" maxlength="5">
                        </div>
                        <div class="form-group">
                            <label>CVV</label>
                            <input type="text" class="form-control" id="cvv" placeholder="123" maxlength="4">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Cardholder Name</label>
                        <input type="text" class="form-control" id="cardName" placeholder="Name on card">
                    </div>
                </div>
                
                <!-- UPI Details (shown when UPI is selected) -->
                <div id="upiDetails" style="margin-top: 2rem; display: none;">
                    <div class="form-group">
                        <label>UPI ID</label>
                        <input type="text" class="form-control" id="upiId" placeholder="yourname@upi">
                    </div>
                    <p style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">
                        <i class="fas fa-info-circle"></i> You'll be redirected to your UPI app for payment
                    </p>
                </div>
            </div>
            
            <div class="cart-summary">
                <h3><i class="fas fa-receipt"></i> Order Summary</h3>
                <div id="checkoutItems">
                    <!-- Order items will be loaded here -->
                </div>
                <div class="summary-item">
                    <span>Subtotal</span>
                    <span>₹<span id="checkoutSubtotal">0</span></span>
                </div>
                <div class="summary-item">
                    <span>Delivery Fee</span>
                    <span id="deliveryFee">₹40</span>
                </div>
                <div class="summary-item total">
                    <span>Total Amount</span>
                    <span>₹<span id="checkoutTotal">0</span></span>
                </div>
                
                <div style="background: #f0f8ff; padding: 1rem; border-radius: 8px; margin: 1.5rem 0;">
                    <p style="color: var(--primary); font-weight: bold; margin: 0;">
                        <i class="fas fa-bolt"></i> 20-Minute Delivery Guarantee!
                    </p>
                    <p style="font-size: 0.9rem; color: #666; margin: 0.5rem 0 0;">
                        Free delivery on orders above ₹500
                    </p>
                </div>
                
                <button class="btn btn-success btn-block" id="placeOrderBtn" style="margin-top: 1rem; padding: 1rem;">
                    <i class="fas fa-check-circle"></i> Confirm & Place Order
                </button>
                
                <p style="text-align: center; margin-top: 1rem; font-size: 0.9rem; color: #666;">
                    By placing this order, you agree to our <a href="#" style="color: var(--primary);">Terms & Conditions</a>
                </p>
            </div>
        </div>
    </main>

    <!-- Order Success Modal -->
    <div id="orderSuccessModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin: 0;"><i class="fas fa-check-circle"></i> Order Successful!</h3>
                <span class="close-modal" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="text-align: center;">
                    <div class="success-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3 style="color: #28a745; margin-bottom: 10px;">Thank You For Your Order!</h3>
                    <p style="color: #666; margin: 15px 0;">
                        Your order has been placed successfully and will be delivered in 20 minutes.
                    </p>
                    
                    <div class="order-summary-box">
                        <p style="margin: 8px 0; font-size: 1.1em;">
                            <strong>Order Number:</strong> <span id="modalOrderId" style="color: #28a745;">ASM123456</span>
                        </p>
                        <p style="margin: 8px 0;">
                            <strong>Estimated Delivery:</strong> 
                            <span id="modalDeliveryTime" style="color: #007bff;">18:45</span>
                        </p>
                        <p style="margin: 8px 0;">
                            <strong>Total Amount:</strong> 
                            <span id="modalTotalAmount" style="color: #dc3545; font-weight: bold;">₹0.00</span>
                        </p>
                        <p style="margin: 8px 0; font-size: 0.9em; color: #6c757d;">
                            <i class="fas fa-info-circle"></i> You can track your order in Order History
                        </p>
                    </div>
                    
                    <p style="color: var(--primary); font-size: 0.9em; margin-top: 20px;">
                        <i class="fas fa-bolt"></i> Your order is being prepared for delivery
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="continueShopping()">
                    <i class="fas fa-shopping-bag"></i> Continue Shopping
                </button>
                <button class="btn btn-primary" onclick="viewOrderHistory()">
                    <i class="fas fa-history"></i> Order History
                </button>
                <button class="btn btn-success" onclick="trackOrder()">
                    <i class="fas fa-map-marker-alt"></i> Track Order
                </button>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>AS Mart</h3>
                    <p>Your trusted 20-minute delivery partner for all daily needs.</p>
                </div>
                <div class="footer-section">
                    <h3>Quick Links</h3>
                    <ul class="footer-links">
                        <li><a href="shop.html">Shop Now</a></li>
                        <li><a href="history.html">My Orders</a></li>
                        <li><a href="tracking.html">Track Order</a></li>
                        <li><a href="reviews.html">Leave Review</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Contact Us</h3>
                    <p><i class="fas fa-phone"></i> +91 9876543210</p>
                    <p><i class="fas fa-envelope"></i> support@asmart.com</p>
                </div>
            </div>
            <div class="copyright">
                <p>&copy; 2024 AS Mart. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        let paymentMethod = 'cash';
        let timerInterval;
        let orderPlaced = false;
        let placedOrderData = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            loadCheckoutItems();
            startPaymentTimer();
            updateCartCount();
            populateSavedAddress();
            setupEventListeners();
            checkCart();
        });
        
        function setupEventListeners() {
            // Place order button click
            document.getElementById('placeOrderBtn').addEventListener('click', function(e) {
                e.preventDefault();
                placeOrder();
            });
            
            // Card number formatting
            document.getElementById('cardNumber')?.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                value = value.replace(/(.{4})/g, '$1 ').trim();
                e.target.value = value.substring(0, 19);
            });
            
            // Expiry date formatting
            document.getElementById('expiry')?.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4);
                }
                e.target.value = value.substring(0, 5);
            });
            
            // CVV max length
            document.getElementById('cvv')?.addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/\D/g, '').substring(0, 4);
            });
            
            // Phone validation
            document.getElementById('phone')?.addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/\D/g, '').substring(0, 10);
            });
            
            // Pincode validation
            document.getElementById('pincode')?.addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/\D/g, '').substring(0, 6);
            });
        }
        
        function checkCart() {
            const cart = getCartFromStorage();
            if (cart.length === 0) {
                document.getElementById('placeOrderBtn').disabled = true;
                document.getElementById('placeOrderBtn').innerHTML = '<i class="fas fa-shopping-cart"></i> Cart is Empty';
                document.getElementById('placeOrderBtn').style.opacity = '0.6';
                document.getElementById('placeOrderBtn').style.cursor = 'not-allowed';
            }
        }
        
        function populateSavedAddress() {
            // Try to load saved address from localStorage
            const savedAddress = JSON.parse(localStorage.getItem('userAddress') || '{}');
            if (savedAddress.fullName) {
                document.getElementById('fullName').value = savedAddress.fullName || '';
                document.getElementById('phone').value = savedAddress.phone || '';
                document.getElementById('email').value = savedAddress.email || '';
                document.getElementById('address').value = savedAddress.address || '';
                document.getElementById('city').value = savedAddress.city || '';
                document.getElementById('pincode').value = savedAddress.pincode || '';
                document.getElementById('instructions').value = savedAddress.instructions || '';
            }
        }
        
        function saveAddressToLocalStorage() {
            const addressData = {
                fullName: document.getElementById('fullName').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                address: document.getElementById('address').value,
                city: document.getElementById('city').value,
                pincode: document.getElementById('pincode').value,
                instructions: document.getElementById('instructions').value
            };
            localStorage.setItem('userAddress', JSON.stringify(addressData));
        }
        
        function selectPayment(method) {
            paymentMethod = method;
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('active');
            });
            event.target.closest('.payment-method').classList.add('active');
            
            // Show/hide payment method details
            document.getElementById('cardDetails').style.display = 
                method === 'card' ? 'block' : 'none';
            document.getElementById('upiDetails').style.display = 
                method === 'upi' ? 'block' : 'none';
        }
        
        function startPaymentTimer() {
            let timeLeft = 300; // 5 minutes in seconds
            const timerElement = document.getElementById('paymentTimer');
            
            timerInterval = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                
                timerElement.textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 60) {
                    timerElement.style.color = '#e74c3c';
                    timerElement.classList.add('timer-warning');
                }
                
                if (timeLeft <= 0 && !orderPlaced) {
                    clearInterval(timerInterval);
                    alert('Payment session expired. Please restart checkout.');
                    window.location.href = 'cart.html';
                }
                
                timeLeft--;
            }, 1000);
        }
        
        function validateForm() {
            // Basic form validation
            const requiredFields = [
                'fullName', 'phone', 'address', 'city', 'pincode'
            ];
            
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.focus();
                    alert(`Please fill in ${field.previousElementSibling.textContent.replace('*', '').trim()}`);
                    return false;
                }
            }
            
            // Phone validation
            const phone = document.getElementById('phone').value;
            if (!/^\d{10}$/.test(phone)) {
                alert('Please enter a valid 10-digit phone number');
                document.getElementById('phone').focus();
                return false;
            }
            
            // Pincode validation
            const pincode = document.getElementById('pincode').value;
            if (!/^\d{6}$/.test(pincode)) {
                alert('Please enter a valid 6-digit pincode');
                document.getElementById('pincode').focus();
                return false;
            }
            
            // Payment method specific validation
            if (paymentMethod === 'card') {
                const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
                const expiry = document.getElementById('expiry').value;
                const cvv = document.getElementById('cvv').value;
                const cardName = document.getElementById('cardName').value;
                
                if (!cardNumber || !expiry || !cvv || !cardName) {
                    alert('Please fill all card details');
                    return false;
                }
                
                if (cardNumber.length !== 16) {
                    alert('Please enter a valid 16-digit card number');
                    return false;
                }
                
                if (!/^\d{2}\/\d{2}$/.test(expiry)) {
                    alert('Please enter expiry date in MM/YY format');
                    return false;
                }
            }
            
            if (paymentMethod === 'upi') {
                const upiId = document.getElementById('upiId').value;
                if (!upiId || !upiId.includes('@')) {
                    alert('Please enter a valid UPI ID (e.g., name@upi)');
                    return false;
                }
            }
            
            return true;
        }
        
        // IMPORTANT: Get cart from localStorage - Check both 'cart' and 'asmartCart' keys
        function getCartFromStorage() {
            // First try 'cart' (from your shop.html)
            let cart = JSON.parse(localStorage.getItem('cart') || '[]');
            
            // If 'cart' is empty, try 'asmartCart' (for backward compatibility)
            if (cart.length === 0) {
                cart = JSON.parse(localStorage.getItem('asmartCart') || '[]');
            }
            
            return cart;
        }
        
        // IMPORTANT: Update cart count from correct storage
        function updateCartCount() {
            const cart = getCartFromStorage();
            const totalItems = cart.reduce((total, item) => total + (item.quantity || 1), 0);
            document.querySelector('.cart-count').textContent = totalItems;
            
            // Update button if cart is empty
            if (totalItems === 0) {
                document.getElementById('placeOrderBtn').disabled = true;
                document.getElementById('placeOrderBtn').innerHTML = '<i class="fas fa-shopping-cart"></i> Cart is Empty';
                document.getElementById('placeOrderBtn').style.opacity = '0.6';
                document.getElementById('placeOrderBtn').style.cursor = 'not-allowed';
            } else {
                document.getElementById('placeOrderBtn').disabled = false;
                document.getElementById('placeOrderBtn').innerHTML = '<i class="fas fa-check-circle"></i> Confirm & Place Order';
                document.getElementById('placeOrderBtn').style.opacity = '1';
                document.getElementById('placeOrderBtn').style.cursor = 'pointer';
            }
        }
        
        // IMPORTANT: Load checkout items from correct storage
        function loadCheckoutItems() {
            const cart = getCartFromStorage();
            const itemsContainer = document.getElementById('checkoutItems');
            let subtotal = 0;
            
            itemsContainer.innerHTML = '';
            
            if (cart.length === 0) {
                itemsContainer.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <i class="fas fa-shopping-cart" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p>Your cart is empty</p>
                        <a href="shop.html" class="btn btn-primary" style="margin-top: 1rem;">
                            <i class="fas fa-store"></i> Start Shopping
                        </a>
                    </div>
                `;
            } else {
                cart.forEach(item => {
                    // Handle both 'price' and 'Price' keys (for compatibility)
                    const price = parseFloat(item.price || item.Price || 0);
                    const quantity = parseInt(item.quantity || 1);
                    const itemTotal = price * quantity;
                    subtotal += itemTotal;
                    
                    // Handle both 'name' and 'productName' keys
                    const itemName = item.name || item.product || item.productName || 'Item';
                    
                    itemsContainer.innerHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee;">
                            <div style="flex: 1;">
                                <span style="font-weight: 500;">${itemName}</span>
                                <div style="font-size: 0.9em; color: #666; margin-top: 2px;">
                                    ₹${price.toFixed(2)} × ${quantity}
                                </div>
                            </div>
                            <div style="text-align: right; font-weight: 600;">
                                ₹${itemTotal.toFixed(2)}
                            </div>
                        </div>
                    `;
                });
            }
            
            const deliveryFee = subtotal >= 500 ? 0 : 40;
            const total = subtotal + deliveryFee;
            
            document.getElementById('checkoutSubtotal').textContent = subtotal.toFixed(2);
            document.getElementById('deliveryFee').textContent = `₹${deliveryFee}`;
            document.getElementById('deliveryFee').style.color = deliveryFee === 0 ? '#28a745' : '#dc3545';
            document.getElementById('checkoutTotal').textContent = total.toFixed(2);
            
            // Update free delivery message
            const deliveryMsg = document.querySelector('.cart-summary p:nth-child(7)');
            if (deliveryMsg) {
                if (subtotal >= 500) {
                    deliveryMsg.innerHTML = '<i class="fas fa-check-circle" style="color: #28a745;"></i> Free delivery applied!';
                }
            }
        }
        
        function placeOrder() {
            if (orderPlaced) {
                alert('Order already placed! Check your order history.');
                return;
            }
            
            // Validate form
            if (!validateForm()) {
                return;
            }
            
            // Get cart items
            const cartItems = getCartFromStorage();
            if (cartItems.length === 0) {
                alert('Your cart is empty!');
                window.location.href = 'shop.html';
                return;
            }
            
            // Disable button to prevent double clicking
            const placeOrderBtn = document.getElementById('placeOrderBtn');
            placeOrderBtn.disabled = true;
            placeOrderBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing Order...';
            
            // Save address
            saveAddressToLocalStorage();
            
            // Prepare order data
            const userData = {
                name: document.getElementById('fullName').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                email: document.getElementById('email').value.trim(),
                address: `${document.getElementById('address').value.trim()}, ${document.getElementById('city').value.trim()} - ${document.getElementById('pincode').value.trim()}`,
                paymentMethod: paymentMethod === 'card' ? 'Card Payment' : 
                              paymentMethod === 'upi' ? 'UPI Payment' : 'Cash on Delivery',
                notes: document.getElementById('instructions').value.trim()
            };
            
            // Calculate total
            const subtotal = cartItems.reduce((sum, item) => {
                return sum + (parseFloat(item.price || item.Price || 0) * (parseInt(item.quantity) || 1));
            }, 0);
            
            const deliveryFee = subtotal >= 500 ? 0 : 40;
            const total = subtotal + deliveryFee;
            
            // Generate order number
            const orderNumber = 'ASM' + Date.now().toString().slice(-8);
            
            // Create order object
            const orderData = {
                id: Date.now(),
                orderNumber: orderNumber,
                customerName: userData.name,
                customerPhone: userData.phone,
                customerEmail: userData.email || 'Not provided',
                deliveryAddress: userData.address,
                items: cartItems.map(item => ({
                    name: item.name || item.product || 'Item',
                    price: parseFloat(item.price || item.Price || 0),
                    quantity: parseInt(item.quantity) || 1,
                    image: item.image || '',
                    category: item.category || 'general'
                })),
                subtotal: subtotal.toFixed(2),
                deliveryFee: deliveryFee.toFixed(2),
                total: total.toFixed(2),
                paymentMethod: userData.paymentMethod,
                deliveryNotes: userData.notes,
                status: 'Pending',
                date: new Date().toLocaleString('en-IN'),
                orderDate: new Date().toISOString(),
                estimatedDelivery: new Date(Date.now() + 20 * 60 * 1000).toISOString(),
                canCancelUntil: new Date(Date.now() + 10 * 60 * 1000).toISOString(),
                userId: localStorage.getItem('currentUserId') || 'guest_' + Date.now(),
                currentStatus: 'Pending'
            };
            
            // Save order to all systems
            saveOrderToAllSystems(orderData);
            
            // Clear cart from both storage keys
            localStorage.removeItem('cart');
            localStorage.removeItem('asmartCart');
            updateCartCount();
            
            // Clear timer
            clearInterval(timerInterval);
            
            // Store order data for modal
            placedOrderData = orderData;
            orderPlaced = true;
            
            // Show success modal after delay
            setTimeout(() => {
                showOrderSuccessModal(orderData);
                placeOrderBtn.disabled = false;
                placeOrderBtn.innerHTML = '<i class="fas fa-check-circle"></i> Order Placed Successfully';
            }, 1500);
        }
        
        function saveOrderToAllSystems(orderData) {
            try {
                // 1. Save to admin system (asmartOrders)
                const adminOrders = JSON.parse(localStorage.getItem('asmartOrders') || '[]');
                adminOrders.unshift(orderData);
                localStorage.setItem('asmartOrders', JSON.stringify(adminOrders));
                
                // 2. Save to general user orders (userOrders)
                const userOrders = JSON.parse(localStorage.getItem('userOrders') || '[]');
                userOrders.unshift(orderData);
                localStorage.setItem('userOrders', JSON.stringify(userOrders));
                
                // 3. Save to user-specific storage
                const userId = localStorage.getItem('currentUserId') || 'guest_' + orderData.id;
                const userKey = 'user_' + userId;
                const userSpecificOrders = JSON.parse(localStorage.getItem(userKey) || '[]');
                userSpecificOrders.unshift(orderData);
                localStorage.setItem(userKey, JSON.stringify(userSpecificOrders));
                
                // 4. Save recent order for quick access
                localStorage.setItem('recentOrder', JSON.stringify(orderData));
                
                console.log('Order saved successfully:', orderData.orderNumber);
                return true;
            } catch (error) {
                console.error('Error saving order:', error);
                alert('Error saving order. Please try again.');
                return false;
            }
        }
        
        function showOrderSuccessModal(orderData) {
            document.getElementById('modalOrderId').textContent = orderData.orderNumber;
            
            // Format delivery time
            const deliveryTime = new Date(orderData.estimatedDelivery);
            document.getElementById('modalDeliveryTime').textContent = 
                deliveryTime.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
            
            document.getElementById('modalTotalAmount').textContent = `₹${orderData.total}`;
            
            document.getElementById('orderSuccessModal').style.display = 'flex';
        }
        
        function closeModal() {
            document.getElementById('orderSuccessModal').style.display = 'none';
        }
        
        function continueShopping() {
            closeModal();
            window.location.href = 'shop.html';
        }
        
        function viewOrderHistory() {
            closeModal();
            window.location.href = 'history.html';
        }
        
        function trackOrder() {
            if (placedOrderData) {
                closeModal();
                window.location.href = `tracking.html?order=${placedOrderData.orderNumber}`;
            } else {
                window.location.href = 'history.html';
            }
        }
        
        // Auto-update cart summary when cart changes
        window.addEventListener('storage', function(e) {
            if (e.key === 'cart' || e.key === 'asmartCart') {
                loadCheckoutItems();
                updateCartCount();
            }
        });
        
        // Also check cart on page visibility change
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                loadCheckoutItems();
                updateCartCount();
            }
        });
    </script>
</body>
</html>