<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order History - AS Mart</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Responsive Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #60a5fa;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --light: #f8fafc;
            --dark: #1e293b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            color: var(--dark);
            background-color: #f5f7fa;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        /* Header & Navigation */
        header {
            background: white;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .logo i {
            font-size: 1.8rem;
        }
        
        .logo span {
            color: var(--dark);
        }
        
        .nav-links {
            display: flex;
            list-style: none;
            gap: 2rem;
            margin: 0;
            padding: 0;
        }
        
        .nav-links a {
            text-decoration: none;
            color: var(--secondary);
            font-weight: 500;
            padding: 0.5rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: color 0.3s;
            border-bottom: 2px solid transparent;
        }
        
        .nav-links a:hover {
            color: var(--primary);
        }
        
        .nav-links a.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        /* Main Content */
        main {
            flex: 1;
            padding: 1rem 0;
        }
        
        .orders-container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .section-title {
            font-size: 1.8rem;
            color: var(--dark);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Buttons */
        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.3s;
            text-decoration: none;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-secondary {
            background: var(--secondary);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        /* Filter Options */
        .filter-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 2rem;
            padding: 1rem;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }
        
        .filter-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--border);
            border-radius: 25px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .filter-btn:hover {
            border-color: var(--primary);
        }
        
        .search-box {
            flex: 1;
            min-width: 250px;
        }
        
        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        /* Orders List */
        .orders-list {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }
        
        .order-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform 0.3s, box-shadow 0.3s;
            animation: fadeInUp 0.5s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .order-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        .order-header {
            padding: 1.25rem;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-bottom: 1px solid var(--border);
            position: relative;
        }
        
        .order-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: var(--primary);
        }
        
        .order-header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .order-id {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .order-date {
            color: var(--secondary);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .order-status {
            display: inline-block;
            padding: 0.3rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-pending { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
        .status-processing { background: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
        .status-ontheway { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .status-delivered { background: #cffafe; color: #155e75; border: 1px solid #a5f3fc; }
        .status-cancelled { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        
        .order-details {
            padding: 1.25rem;
        }
        
        .order-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        
        .order-items {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .order-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            background: #f8fafc;
            border-radius: 8px;
            transition: background-color 0.3s;
        }
        
        .order-item:hover {
            background: #f1f5f9;
        }
        
        .item-image {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            overflow: hidden;
            background: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: var(--secondary);
            flex-shrink: 0;
        }
        
        .item-details {
            flex: 1;
            min-width: 0;
        }
        
        .item-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.95rem;
        }
        
        .item-price {
            color: var(--primary);
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .item-quantity {
            color: var(--secondary);
            font-size: 0.85rem;
        }
        
        .order-info {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .info-card {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid var(--border);
            transition: transform 0.3s;
        }
        
        .info-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .info-card h4 {
            margin-bottom: 0.75rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px dashed var(--border);
            font-size: 0.9rem;
        }
        
        .info-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .info-label {
            color: var(--secondary);
            font-weight: 500;
        }
        
        .info-value {
            font-weight: 600;
            text-align: right;
            max-width: 60%;
            word-break: break-word;
        }
        
        .order-actions {
            padding: 1rem 1.25rem;
            background: #f8fafc;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .empty-icon {
            font-size: 3rem;
            color: #cbd5e1;
            margin-bottom: 1rem;
        }
        
        /* Statistics */
        .stats-card {
            background: white;
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .stat-item {
            text-align: center;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 8px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .stat-item:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: var(--secondary);
            font-size: 0.85rem;
        }
        
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.75rem;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
        }
        
        .page-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .page-btn:hover:not(:disabled) {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .page-numbers {
            display: flex;
            gap: 0.25rem;
        }
        
        .page-number {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .page-number.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* Footer */
        footer {
            background: var(--dark);
            color: white;
            padding: 3rem 0 1.5rem;
            margin-top: auto;
        }
        
        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .footer-section h3 {
            margin-bottom: 1rem;
            color: white;
        }
        
        .footer-links {
            list-style: none;
        }
        
        .footer-links li {
            margin-bottom: 0.5rem;
        }
        
        .footer-links a {
            color: #cbd5e1;
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .footer-links a:hover {
            color: white;
        }
        
        .copyright {
            text-align: center;
            padding-top: 1.5rem;
            border-top: 1px solid #334155;
            color: #94a3b8;
            font-size: 0.9rem;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            animation: fadeIn 0.3s ease-out;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f1f5f9;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Product Icons */
        .fruits { color: #10b981; }
        .vegetables { color: #84cc16; }
        .dairy { color: #f59e0b; }
        .meat { color: #ef4444; }
        .bakery { color: #ec4899; }
        .beverages { color: #06b6d4; }
        .snacks { color: #8b5cf6; }
        .electronics { color: #3b82f6; }
        .home { color: #f97316; }
        .pharmacy { color: #8b5cf6; }
        
        /* Responsive Design */
        @media (min-width: 768px) {
            .orders-container {
                padding: 1.5rem;
            }
            
            .order-row {
                grid-template-columns: 1fr 1fr;
                gap: 2rem;
            }
            
            .section-title {
                font-size: 2rem;
            }
            
            .order-actions {
                flex-wrap: nowrap;
            }
            
            .order-actions .btn {
                flex: 1;
            }
            
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        @media (min-width: 1024px) {
            .orders-container {
                padding: 2rem;
            }
            
            .order-header-top {
                flex-wrap: nowrap;
            }
            
            .order-date {
                flex-wrap: nowrap;
            }
        }
        
        @media (max-width: 767px) {
            .navbar {
                padding: 0.75rem 0;
            }
            
            .nav-links {
                gap: 1rem;
                overflow-x: auto;
                padding: 0.5rem 0;
            }
            
            .nav-links li {
                flex-shrink: 0;
            }
            
            .page-header {
                flex-direction: column;
            }
            
            .page-header > div:last-child {
                display: flex;
                gap: 0.5rem;
                flex-wrap: wrap;
            }
            
            .filter-options {
                flex-direction: column;
            }
            
            .search-box {
                min-width: 100%;
            }
            
            .order-actions {
                flex-direction: column;
            }
            
            .order-actions .btn {
                width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .logo h1 {
                font-size: 1.25rem;
            }
            
            .nav-links a span {
                display: none;
            }
            
            .nav-links a i {
                font-size: 1.2rem;
            }
            
            .btn {
                padding: 0.5rem 0.75rem;
                font-size: 0.85rem;
            }
            
            .filter-btn {
                padding: 0.375rem 0.75rem;
                font-size: 0.8rem;
            }
            
            .stat-value {
                font-size: 1.25rem;
            }
        }
        
        /* Print Styles */
        @media print {
            .no-print {
                display: none !important;
            }
            
            .order-card {
                box-shadow: none;
                border: 1px solid #ddd;
                page-break-inside: avoid;
            }
            
            .order-actions {
                display: none;
            }
            
            .filter-options {
                display: none;
            }
            
            .page-header {
                display: none;
            }
            
            header, footer {
                display: none;
            }
        }
    </style>
</head>
<body>
    <header>
        <nav class="navbar container">
            <div class="logo">
                <i class="fas fa-bolt"></i>
                <h1>AS <span>Mart</span></h1>
            </div>
            
            <ul class="nav-links">
                <li><a href="index.html"><i class="fas fa-home"></i> <span>Home</span></a></li>
                <li><a href="shop.html"><i class="fas fa-store"></i> <span>Shop</span></a></li>
                <li><a href="history.html" class="active"><i class="fas fa-history"></i> <span>History</span></a></li>
                <li><a href="tracking.html"><i class="fas fa-map-marker-alt"></i> <span>Track</span></a></li>
                <li><a href="reviews.html"><i class="fas fa-star"></i> <span>Reviews</span></a></li>
            </ul>
        </nav>
    </header>

    <main class="orders-container">
        <div class="page-header">
            <div>
                <h2 class="section-title"><i class="fas fa-history"></i> Order History</h2>
                <p style="color: var(--secondary); margin-top: 0.5rem; font-size: 0.95rem;">View and manage all your past and current orders</p>
            </div>
            <div>
                <button class="btn no-print" onclick="printOrders()" title="Print Orders">
                    <i class="fas fa-print"></i>
                </button>
                <button class="btn no-print" onclick="exportOrders()" title="Export to CSV">
                    <i class="fas fa-download"></i>
                </button>
                <button class="btn no-print" onclick="refreshOrders()">
                    <i class="fas fa-sync-alt"></i> <span>Refresh</span>
                </button>
                <button class="btn btn-primary" onclick="location.href='shop.html'">
                    <i class="fas fa-plus"></i> <span>New Order</span>
                </button>
            </div>
        </div>
        
        <!-- Order Statistics -->
        <div class="stats-card no-print">
            <h3><i class="fas fa-chart-line"></i> Order Statistics</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="totalOrders">0</div>
                    <div class="stat-label">Total Orders</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalSpent">$0</div>
                    <div class="stat-label">Total Spent</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avgOrder">$0</div>
                    <div class="stat-label">Average Order</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="lastOrder">--</div>
                    <div class="stat-label">Last Order</div>
                </div>
            </div>
        </div>
        
        <div class="filter-options no-print">
            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; flex: 1;">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="current">Current</button>
                <button class="filter-btn" data-filter="pending">Pending</button>
                <button class="filter-btn" data-filter="processing">Processing</button>
                <button class="filter-btn" data-filter="ontheway">On the Way</button>
                <button class="filter-btn" data-filter="delivered">Delivered</button>
                <button class="filter-btn" data-filter="cancelled">Cancelled</button>
            </div>
            <div class="search-box">
                <input type="text" id="searchOrders" placeholder="Search by order ID, item, or store..." 
                       class="form-control" onkeyup="searchOrders()">
            </div>
        </div>
        
        <div id="ordersLoading" class="loading" style="display: none;">
            <div class="loading-spinner"></div>
            <p>Loading your orders...</p>
        </div>
        
        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="empty-icon">
                <i class="fas fa-shopping-bag"></i>
            </div>
            <h3>No Orders Yet</h3>
            <p style="color: var(--secondary); max-width: 400px; margin: 1rem auto;">
                You haven't placed any orders yet. Start shopping to see your order history here.
            </p>
            <button class="btn btn-primary back-to-shop" onclick="location.href='shop.html'">
                <i class="fas fa-store"></i> Start Shopping
            </button>
        </div>
        
        <div id="ordersList" class="orders-list">
            <!-- Orders will be loaded here -->
        </div>
        
        <!-- Pagination -->
        <div id="pagination" class="pagination no-print" style="display: none;">
            <button class="page-btn" onclick="changePage(-1)" id="prevBtn" disabled>
                <i class="fas fa-chevron-left"></i> <span>Previous</span>
            </button>
            <div class="page-numbers" id="pageNumbers"></div>
            <button class="page-btn" onclick="changePage(1)" id="nextBtn" disabled>
                <span>Next</span> <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>AS Mart</h3>
                    <p>Your trusted 20-minute delivery partner for all daily needs.</p>
                </div>
                <div class="footer-section">
                    <h3>Quick Links</h3>
                    <ul class="footer-links">
                        <li><a href="shop.html">Shop Now</a></li>
                        <li><a href="history.html">Order History</a></li>
                        <li><a href="tracking.html">Track Order</a></li>
                        <li><a href="reviews.html">Leave Review</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Contact Us</h3>
                    <p><i class="fas fa-phone"></i> +1 234 567 890</p>
                    <p><i class="fas fa-envelope"></i> support@asmart.com</p>
                </div>
            </div>
            <div class="copyright">
                <p>&copy; 2024 AS Mart. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Modals (truncated for brevity - same as original) -->
    <div id="cancelModal" class="modal" style="display: none;">
        <!-- Modal content remains the same -->
    </div>

    <div id="orderDetailsModal" class="modal" style="display: none;">
        <!-- Modal content remains the same -->
    </div>

<script>
    // Order History Management System
    let allOrders = [];
    let currentFilter = 'all';
    let orderToCancel = null;
    let currentPage = 1;
    const ordersPerPage = 5;
    let filteredOrders = [];

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
        initializeHistoryPage();
    });

    function initializeHistoryPage() {
        loadOrders();
        setupEventListeners();
    }

    function loadOrders() {
        showLoadingState();
        
        setTimeout(() => {
            try {
                // Get orders from standardized location
                const orders = getOrdersFromStorage();
                
                if (orders.length === 0) {
                    showEmptyState();
                    return;
                }
                
                // Sort orders by date (newest first)
                orders.sort((a, b) => new Date(b.orderDate || b.date) - new Date(a.orderDate || a.date));
                
                allOrders = orders;
                filteredOrders = [...allOrders];
                
                // Calculate statistics
                calculateOrderStatistics();
                
                // Apply current filter
                applyFilter(currentFilter);
                
                hideLoadingState();
                
            } catch (error) {
                console.error('Error loading orders:', error);
                showErrorState();
            }
        }, 500);
    }

    function getOrdersFromStorage() {
        let orders = [];
        
        // First, check the standard location
        const standardOrders = JSON.parse(localStorage.getItem('asmart_user_orders') || '[]');
        orders.push(...standardOrders);
        
        // Check legacy locations
        const legacyOrders = JSON.parse(localStorage.getItem('userOrders') || '[]');
        orders.push(...legacyOrders);
        
        // Check admin orders (filter by user phone if available)
        const adminOrders = JSON.parse(localStorage.getItem('asmartOrders') || '[]');
        const userPhone = localStorage.getItem('userPhone');
        if (userPhone && adminOrders.length > 0) {
            const userAdminOrders = adminOrders.filter(order => 
                order.customerPhone === userPhone || 
                order.userPhone === userPhone
            );
            orders.push(...userAdminOrders);
        } else {
            orders.push(...adminOrders);
        }
        
        // Remove duplicates by order number/id
        const uniqueOrders = [];
        const seenOrders = new Set();
        
        orders.forEach(order => {
            const orderKey = order.orderNumber || order.id || order.orderId;
            if (orderKey && !seenOrders.has(orderKey)) {
                seenOrders.add(orderKey);
                
                // Standardize the order object
                uniqueOrders.push({
                    id: order.id || Date.now(),
                    orderNumber: order.orderNumber || order.orderId || `ORD${Date.now().toString().slice(-6)}`,
                    customerName: order.customerName || order.userName || 'Customer',
                    customerPhone: order.customerPhone || order.userPhone || '',
                    deliveryAddress: order.deliveryAddress || order.address || '',
                    items: Array.isArray(order.items) ? order.items : [],
                    total: parseFloat(order.total || order.totalAmount || 0),
                    paymentMethod: order.paymentMethod || 'Cash on Delivery',
                    status: order.status || order.currentStatus || 'Pending',
                    date: order.date || order.orderDate || new Date().toISOString(),
                    store: order.store || order.localMarket || 'AS Mart'
                });
            }
        });
        
        return uniqueOrders;
    }

    function displayOrders(orders) {
        const ordersList = document.getElementById('ordersList');
        
        if (orders.length === 0) {
            ordersList.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <h3>No Orders Found</h3>
                    <p style="color: var(--secondary);">No orders match your current filter.</p>
                    <button class="btn btn-primary" onclick="clearFilters()">
                        <i class="fas fa-filter"></i> Clear Filters
                    </button>
                </div>
            `;
            return;
        }
        
        // Calculate pagination
        const totalPages = Math.ceil(orders.length / ordersPerPage);
        const startIndex = (currentPage - 1) * ordersPerPage;
        const endIndex = startIndex + ordersPerPage;
        const pageOrders = orders.slice(startIndex, endIndex);
        
        ordersList.innerHTML = pageOrders.map(order => {
            const status = order.status || 'Pending';
            const statusClass = getStatusClass(status);
            const orderDate = new Date(order.date);
            const canCancel = canOrderBeCancelled(order);
            
            // Calculate total
            const total = order.total || 
                (order.items ? order.items.reduce((sum, item) => 
                    sum + (item.price * (item.quantity || 1)), 0) : 0);
            
            return `
                <div class="order-card" id="order-${order.orderNumber}">
                    <div class="order-header">
                        <div class="order-header-top">
                            <div>
                                <div class="order-id">
                                    <i class="fas fa-receipt"></i> Order #${order.orderNumber}
                                </div>
                                <div class="order-date">
                                    <i class="far fa-calendar"></i> ${orderDate.toLocaleDateString('en-IN', {
                                        weekday: 'short',
                                        year: 'numeric',
                                        month: 'short',
                                        day: 'numeric'
                                    })} 
                                    <i class="far fa-clock" style="margin-left: 0.5rem;"></i> ${orderDate.toLocaleTimeString('en-IN', {
                                        hour: '2-digit',
                                        minute:'2-digit'
                                    })}
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                                <span class="order-status ${statusClass}">
                                    <i class="fas ${getStatusIcon(status)}"></i> ${status}
                                </span>
                                <div style="font-size: 1.1rem; font-weight: bold; color: var(--primary);">
                                    ₹${total.toFixed(2)}
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; font-size: 0.85rem; margin-top: 0.5rem;">
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <div>
                                    <i class="fas fa-credit-card"></i> 
                                    <span style="color: var(--secondary);">Payment:</span> 
                                    <strong>${getPaymentMethodName(order.paymentMethod)}</strong>
                                </div>
                                <div>
                                    <i class="fas fa-store"></i> 
                                    <span style="color: var(--secondary);">Store:</span> 
                                    <strong>${order.store || 'AS Mart'}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="order-details">
                        <div class="order-row">
                            <div class="order-items">
                                <h4 style="color: var(--primary); margin-bottom: 0.75rem; font-size: 0.95rem;">
                                    <i class="fas fa-shopping-bag"></i> Order Items (${order.items ? order.items.length : 0})
                                </h4>
                                ${order.items && order.items.length > 0 ? order.items.slice(0, 3).map(item => `
                                    <div class="order-item">
                                        <div class="item-image">
                                            ${getProductIcon(item.category || 'default')}
                                        </div>
                                        <div class="item-details">
                                            <div class="item-name">${item.name || 'Product'}</div>
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <div>
                                                    <span class="item-price">₹${((item.price || 0) * (item.quantity || 1)).toFixed(2)}</span>
                                                    <span class="item-quantity"> (x${item.quantity || 1})</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('') : '<p style="color: var(--secondary); text-align: center; font-size: 0.9rem;">No items details available</p>'}
                            </div>
                            
                            <div class="order-info">
                                <div class="info-card">
                                    <h4><i class="fas fa-user-circle"></i> Customer Info</h4>
                                    <div class="info-item">
                                        <span class="info-label">Name</span>
                                        <span class="info-value">${order.customerName || 'Customer'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Phone</span>
                                        <span class="info-value">${order.customerPhone || 'N/A'}</span>
                                    </div>
                                </div>
                                
                                <div class="info-card">
                                    <h4><i class="fas fa-info-circle"></i> Order Summary</h4>
                                    <div class="info-item">
                                        <span class="info-label">Subtotal</span>
                                        <span class="info-value">₹${total.toFixed(2)}</span>
                                    </div>
                                    <div class="info-item" style="border-top: 2px solid var(--primary); padding-top: 0.5rem;">
                                        <span class="info-label" style="font-weight: bold;">Total</span>
                                        <span class="info-value" style="font-weight: bold;">₹${total.toFixed(2)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="order-actions">
                        <button class="btn btn-primary" onclick="trackOrder('${order.orderNumber}')">
                            <i class="fas fa-map-marker-alt"></i> Track Order
                        </button>
                        ${canCancel ? `
                            <button class="btn btn-danger" onclick="openCancelModal('${order.orderNumber}')">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        ` : ''}
                        ${status === 'Delivered' ? `
                            <button class="btn btn-success" onclick="rateOrder('${order.orderNumber}')">
                                <i class="fas fa-star"></i> Review
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }).join('');
        
        // Update pagination
        updatePagination(orders.length);
    }

    function applyFilter(filterType) {
        currentFilter = filterType;
        currentPage = 1;
        
        // Update active filter button
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.filter === filterType) {
                btn.classList.add('active');
            }
        });
        
        // Apply filter
        switch(filterType) {
            case 'all':
                filteredOrders = [...allOrders];
                break;
            case 'current':
                filteredOrders = allOrders.filter(order => 
                    !['Delivered', 'Cancelled'].includes(order.status || '')
                );
                break;
            case 'pending':
                filteredOrders = allOrders.filter(order => 
                    order.status === 'Pending'
                );
                break;
            case 'processing':
                filteredOrders = allOrders.filter(order => 
                    order.status === 'Processing'
                );
                break;
            case 'ontheway':
                filteredOrders = allOrders.filter(order => 
                    order.status === 'On the Way'
                );
                break;
            case 'delivered':
                filteredOrders = allOrders.filter(order => 
                    order.status === 'Delivered'
                );
                break;
            case 'cancelled':
                filteredOrders = allOrders.filter(order => 
                    order.status === 'Cancelled'
                );
                break;
            default:
                filteredOrders = [...allOrders];
        }
        
        displayOrders(filteredOrders);
    }

    function searchOrders() {
        const searchTerm = document.getElementById('searchOrders').value.toLowerCase().trim();
        
        if (!searchTerm) {
            filteredOrders = [...allOrders];
            applyFilter(currentFilter);
            return;
        }
        
        filteredOrders = allOrders.filter(order => {
            const orderId = (order.orderNumber || '').toString().toLowerCase();
            const storeName = (order.store || '').toLowerCase();
            const customerName = (order.customerName || '').toLowerCase();
            
            // Search in order ID
            if (orderId.includes(searchTerm)) return true;
            
            // Search in store name
            if (storeName.includes(searchTerm)) return true;
            
            // Search in customer name
            if (customerName.includes(searchTerm)) return true;
            
            return false;
        });
        
        currentPage = 1;
        displayOrders(filteredOrders);
    }

    function calculateOrderStatistics() {
        const totalOrders = allOrders.length;
        const totalSpent = allOrders.reduce((sum, order) => 
            sum + (order.total || 0), 0);
        const avgOrder = totalOrders > 0 ? totalSpent / totalOrders : 0;
        const lastOrder = allOrders.length > 0 ? 
            new Date(allOrders[0].date).toLocaleDateString('en-IN', {
                day: 'numeric',
                month: 'short'
            }) : '--';
        
        document.getElementById('totalOrders').textContent = totalOrders;
        document.getElementById('totalSpent').textContent = '₹' + totalSpent.toFixed(2);
        document.getElementById('avgOrder').textContent = '₹' + avgOrder.toFixed(2);
        document.getElementById('lastOrder').textContent = lastOrder;
    }

    function updatePagination(totalItems) {
        const paginationDiv = document.getElementById('pagination');
        const pageNumbersDiv = document.getElementById('pageNumbers');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        
        const totalPages = Math.ceil(totalItems / ordersPerPage);
        
        if (totalPages <= 1) {
            paginationDiv.style.display = 'none';
            return;
        }
        
        paginationDiv.style.display = 'flex';
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === totalPages;
        
        // Generate page numbers
        pageNumbersDiv.innerHTML = '';
        const maxPagesToShow = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
        let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
        
        if (endPage - startPage + 1 < maxPagesToShow) {
            startPage = Math.max(1, endPage - maxPagesToShow + 1);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const pageBtn = document.createElement('div');
            pageBtn.className = `page-number ${i === currentPage ? 'active' : ''}`;
            pageBtn.textContent = i;
            pageBtn.onclick = () => changePageTo(i);
            pageNumbersDiv.appendChild(pageBtn);
        }
    }

    function changePage(direction) {
        const totalPages = Math.ceil(filteredOrders.length / ordersPerPage);
        const newPage = currentPage + direction;
        
        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            displayOrders(filteredOrders);
        }
    }

    function changePageTo(pageNumber) {
        const totalPages = Math.ceil(filteredOrders.length / ordersPerPage);
        
        if (pageNumber >= 1 && pageNumber <= totalPages) {
            currentPage = pageNumber;
            displayOrders(filteredOrders);
        }
    }

    function clearFilters() {
        document.getElementById('searchOrders').value = '';
        currentFilter = 'all';
        applyFilter('all');
    }

    function getStatusClass(status) {
        const statusMap = {
            'pending': 'status-pending',
            'processing': 'status-processing',
            'on the way': 'status-ontheway',
            'delivered': 'status-delivered',
            'cancelled': 'status-cancelled',
            'out for delivery': 'status-ontheway'
        };
        return statusMap[status.toLowerCase()] || 'status-pending';
    }

    function getStatusIcon(status) {
        const iconMap = {
            'pending': 'fa-clock',
            'processing': 'fa-cog',
            'on the way': 'fa-shipping-fast',
            'delivered': 'fa-check-circle',
            'cancelled': 'fa-times-circle',
            'out for delivery': 'fa-truck'
        };
        return iconMap[status.toLowerCase()] || 'fa-clock';
    }

    function getPaymentMethodName(method) {
        const methods = {
            'card': 'Credit/Debit Card',
            'cash': 'Cash on Delivery',
            'wallet': 'Digital Wallet',
            'upi': 'UPI Payment',
            'netbanking': 'Net Banking'
        };
        return methods[method] || method || 'Cash on Delivery';
    }

    function getProductIcon(category) {
        const icons = {
            'fruits': '<i class="fas fa-apple-alt fruits product-icon"></i>',
            'vegetables': '<i class="fas fa-carrot vegetables product-icon"></i>',
            'dairy': '<i class="fas fa-cheese dairy product-icon"></i>',
            'meat': '<i class="fas fa-drumstick-bite meat product-icon"></i>',
            'bakery': '<i class="fas fa-bread-slice bakery product-icon"></i>',
            'beverages': '<i class="fas fa-wine-bottle beverages product-icon"></i>',
            'snacks': '<i class="fas fa-cookie snacks product-icon"></i>',
            'electronics': '<i class="fas fa-laptop electronics product-icon"></i>',
            'home': '<i class="fas fa-home home product-icon"></i>',
            'pharmacy': '<i class="fas fa-pills pharmacy product-icon"></i>'
        };
        return icons[category.toLowerCase()] || '<i class="fas fa-shopping-bag product-icon" style="color: var(--secondary);"></i>';
    }

    function canOrderBeCancelled(order) {
        const status = order.status;
        if (status === 'Cancelled' || status === 'Delivered') return false;
        
        const orderDate = new Date(order.date);
        const cancelUntil = new Date(orderDate.getTime() + 10 * 60 * 1000); // 10 minutes
        return new Date() < cancelUntil;
    }

    function trackOrder(orderNumber) {
        // Save the order number to track
        localStorage.setItem('currentTrackingOrder', orderNumber);
        window.location.href = 'tracking.html';
    }

    function rateOrder(orderNumber) {
        // Save the order number for review
        localStorage.setItem('currentReviewOrder', orderNumber);
        window.location.href = 'reviews.html';
    }

    function refreshOrders() {
        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing';
        btn.disabled = true;
        
        loadOrders();
        
        setTimeout(() => {
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        }, 1000);
    }

    function setupEventListeners() {
        // Filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const filterType = this.dataset.filter;
                applyFilter(filterType);
            });
        });
        
        // Search input
        document.getElementById('searchOrders').addEventListener('keyup', searchOrders);
    }

    function showLoadingState() {
        document.getElementById('ordersLoading').style.display = 'block';
        document.getElementById('ordersList').innerHTML = '';
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('pagination').style.display = 'none';
    }

    function hideLoadingState() {
        document.getElementById('ordersLoading').style.display = 'none';
    }

    function showEmptyState() {
        document.getElementById('ordersLoading').style.display = 'none';
        document.getElementById('ordersList').innerHTML = '';
        document.getElementById('emptyState').style.display = 'block';
        document.getElementById('pagination').style.display = 'none';
    }

    function showErrorState() {
        document.getElementById('ordersLoading').style.display = 'none';
        document.getElementById('ordersList').innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-map-marker-alt"></i>
                </div>
                <h3>Track Your Previous Orders</h3>
                <p style="color: var(--secondary); margin: 1rem 0;">
                    To view your order history and track previous orders, please visit the tracking page.
                </p>
                <button class="btn btn-primary" onclick="location.href='tracking.html'">
                    <i class="fas fa-map-marker-alt"></i> Go to Tracking Page
                </button>
            </div>
        `;
    }

    function printOrders() {
        if (allOrders.length === 0) {
            alert('No orders to print');
            return;
        }
        window.print();
    }

    function exportOrders() {
        if (filteredOrders.length === 0) {
            alert('No orders to export');
            return;
        }
        
        // Create CSV content
        let csvContent = "Order ID,Date,Status,Total,Store,Payment Method\n";
        
        filteredOrders.forEach(order => {
            const date = new Date(order.date);
            const total = order.total || 0;
            const status = order.status;
            const store = order.store || 'AS Mart';
            const paymentMethod = getPaymentMethodName(order.paymentMethod);
            
            csvContent += `"${order.orderNumber}","${date.toLocaleDateString()}","${status}","${total}","${store}","${paymentMethod}"\n`;
        });
        
        // Create download link
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `asmart-orders-${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        alert('Orders exported successfully!');
    }
</script>
</body>
</html>